<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MS 服飾管理系統</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #FFFBF5; /* 更亮的奶油底色 */
            color: #4A4A4A;
        }

        /* 新版莫蘭迪/奶茶亮色系定義 */
        .bg-cream { background-color: #FFFBF5; }
        .bg-milk-light { background-color: #F7EFE5; } /* 淺奶茶 */
        .bg-milk-dark { background-color: #E3D5CA; }  /* 深奶茶 */
        
        .bg-sage-green { background-color: #A4C3B2; } /* 莫蘭迪綠 */
        .bg-dusty-pink { background-color: #E5B3BB; } /* 乾燥玫瑰粉 */
        
        .text-sage-dark { color: #6B8F7D; }
        .text-pink-dark { color: #B5838D; }
        
        .input-field {
            @apply w-full p-2.5 rounded-xl border border-[#E3D5CA] bg-white focus:outline-none focus:ring-2 focus:ring-[#A4C3B2] transition-all text-gray-700 shadow-sm;
        }
        
        .btn-primary {
            @apply bg-[#A4C3B2] text-white px-5 py-2.5 rounded-xl hover:bg-[#8FB09E] transition-all shadow-md flex items-center justify-center gap-2 font-bold tracking-wide;
        }

        .btn-secondary {
            @apply bg-[#E5B3BB] text-white px-5 py-2.5 rounded-xl hover:bg-[#D59CA5] transition-all shadow-md flex items-center justify-center gap-2 font-bold tracking-wide;
        }

        .card {
            @apply bg-white rounded-3xl shadow-xl shadow-gray-100/50 p-6 border border-[#F7EFE5];
        }

        .section-title {
            @apply text-lg font-bold mb-4 flex items-center gap-2;
        }

        .table-header {
            @apply bg-[#F7EFE5] text-[#6B6B6B] font-bold;
        }

        /* 隱藏 Scrollbar 但保持功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .logistics-group-title {
            @apply text-xs font-bold text-gray-400 mt-4 mb-2 pl-2 border-l-4 border-[#E3D5CA];
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- Firebase Configuration ---
        // 使用 Canvas 提供的全域變數，若未定義則使用預設
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "AIzaSyAc_WnUBQz6nYqoUNZmMHBm62lKMITAxYA",
                authDomain: "ms-app-710ea.firebaseapp.com",
                projectId: "ms-app-710ea",
                storageBucket: "ms-app-710ea.firebasestorage.app",
                messagingSenderId: "718163218564",
                appId: "1:718163218564:web:ba38466e922ffd27aa32d1"
            };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        // 設定 Firestore 錯誤日誌級別
        firebase.firestore.setLogLevel('Debug');
        
        // --- Icons ---
        const Icons = {
            Plus: () => <i data-lucide="plus"></i>,
            Trash: () => <i data-lucide="trash-2"></i>,
            Edit: () => <i data-lucide="edit"></i>,
            Search: () => <i data-lucide="search"></i>,
            Download: () => <i data-lucide="download"></i>,
            Calculator: () => <i data-lucide="calculator"></i>,
            Package: () => <i data-lucide="package"></i>,
            TrendingUp: () => <i data-lucide="trending-up"></i>,
            Shirt: () => <i data-lucide="shirt"></i>,
            History: () => <i data-lucide="history"></i>,
            Check: () => <i data-lucide="check-circle"></i>
        };

        // --- Utility Functions ---
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(amount);
        };
        
        // --- Excel Export Helper Functions ---
        const SHOPEE_FEE_RATE = 0.12; // 12% 估計總費用 (包含手續費、系統費、活動費等)
        const ECOMMERCE_FEE_RATE = 0.05; // 5% 估計總費用 (例如綠界金流手續費)

        /**
         * 估算利潤公式: 優惠價 - 成本 - (優惠價 * 平台費用率)
         * @param {number} price 優惠價
         * @param {number} cost 總成本 (TWD)
         * @param {number} feeRate 平台費用率
         * @returns {number} 估計利潤 (TWD)
         */
        const calculateEstimatedProfit = (price, cost, feeRate) => {
            price = Number(price) || 0;
            cost = Number(cost) || 0;
            if (price <= 0) return 0;
            
            // 估計總費用: 平台費率包含所有手續費、系統費、活動費等，實際情況複雜，此為簡化計算
            let totalPlatformFee = price * feeRate; 
            let profit = price - cost - totalPlatformFee;
            
            return Math.round(profit); // 四捨五入到整數
        };


        // --- Components ---

        // 1. Calculator Component
        const Calculator = () => {
            const [mode, setMode] = useState('korea'); // 'korea' or 'taobao'
            
            // Korea Inputs
            const [koreaData, setKoreaData] = useState({
                category: '服飾類',
                priceWon: 0,
                qty: 1,
                weight: 0.5,
                rate: 40, 
            });

            // Taobao Inputs
            const [taobaoData, setTaobaoData] = useState({
                category: '服飾類',
                priceCny: 0,
                qty: 1,
                weight: 0.5,
                rate: 4.5,
                hasPremium: false, // 尊榮
                premiumRate: 5,
                hasTax: true,      // 關稅
            });

            // Selling Inputs
            const [sellData, setSellData] = useState({
                totalCost: 0,
                marginPercent: 50, // 50%
            });

            const categories = [
                { name: '服飾類', tax: 40 },
                { name: '生活用品/雜貨類', tax: 45 },
                { name: '美妝類', tax: 50 },
                { name: '食品/兒童玩具類', tax: 60 },
                { name: '無須關稅/免運', tax: 0 },
            ];

            const getCategoryTax = (catName) => {
                const cat = categories.find(c => c.name === catName);
                return cat ? cat.tax : 0;
            };

            // Logistics Formulas (Korea) - 已根據用戶要求修正
            const calculateKoreaLogistics = useCallback(() => {
                const { priceWon, qty, weight, rate, category } = koreaData;
                const taxPerKg = getCategoryTax(category);
                
                const W = parseFloat(weight) || 0; // 重量 (kg)
                const P = parseFloat(priceWon) || 0; // 商品單價 (KRW)
                const R = parseFloat(rate) || 1; // 匯率
                const Q = parseFloat(qty) || 1; // 數量

                // 代購費率固定 3%
                const AGENCY_FEE_RATE = 0.03;
                
                /**
                 * 核心計算函式 (根據用戶要求修正)
                 * @param {number} freightRate 運費單價 (KRW/kg)
                 * @param {'taxed'|'notax'} type 物流類型 (含稅/未稅)
                 * @returns {object} 包含總成本與細項
                 */
                const calc = (freightRate, type) => {
                    // 1. Item Cost in KRW
                    const itemCostKRW = P * Q; 
                    // 2. Freight Cost in KRW (Weight-based)
                    const freightCostKRW = freightRate * W;
                    // 3. Agency Service Fee in KRW (3% of item cost)
                    const serviceFeeKRW = itemCostKRW * AGENCY_FEE_RATE;

                    // Total KRW components to convert
                    const totalKRW = itemCostKRW + freightCostKRW + serviceFeeKRW;
                    
                    // --- TWD Calculation ---
                    // 將所有韓幣成本一次轉換成台幣
                    const totalTWDFromKRW = Math.round(totalKRW / R); 

                    let taxTWD = 0;
                    // 只有在未稅 (notax) 且產品類別需要關稅時，才手動計算關稅
                    if (type === 'notax' && taxPerKg > 0) {
                        taxTWD = Math.round(taxPerKg * W); 
                    }
                    
                    const pkgTWD = 15; // 固定包材費

                    // Final Total Cost TWD
                    const finalCost = totalTWDFromKRW + taxTWD + pkgTWD;

                    return {
                        cost: finalCost,
                        breakdown: { itemCostKRW, freightCostKRW, serviceFeeKRW, totalTWDFromKRW, taxTWD, pkgTWD }
                    };
                };

                const makeOpt = (group, name, freight, type) => {
                    const res = calc(freight, type);
                    return { group, name, cost: res.cost, breakdown: res.breakdown };
                };

                // Define Logistics Groups (Freight rates are example KRW/kg)
                // 數據為模擬，用於演示邏輯
                const rawList = [
                    makeOpt('EASYBOX', '空運-含稅-10kg', 7800, 'taxed'),
                    makeOpt('EASYBOX', '空運-未稅-10kg', 5900, 'notax'),
                    makeOpt('EASYBOX', '海運-未稅-10kg', 3900, 'notax'),
                    
                    makeOpt('SL', '空運(直飛)-含稅-10kg', 6100, 'taxed'),
                    makeOpt('SL', '空運(轉機)-含稅-10kg', 5100, 'taxed'),
                    makeOpt('SL', '空運(轉機)-未稅-5kg', 3500, 'notax'),
                    makeOpt('SL', '空運(直飛)-未稅-5kg', 4500, 'notax'),
                    
                    makeOpt('TN', '空運-含稅-10kg (高單價適用)', 6500, 'taxed'),
                    makeOpt('TN', '空運-未稅-5kg', 5000, 'notax'),
                    
                    makeOpt('九泰', '空運-未稅-1kg', 3800, 'notax'),
                    
                    makeOpt('SS', '空運-未稅-5kg', 5000, 'notax'),
                ];

                return rawList;
            }, [koreaData, getCategoryTax]);

            const calculateTaobao = useMemo(() => {
                const { priceCny, qty, weight, rate, hasPremium, premiumRate, hasTax, category } = taobaoData;
                const P = parseFloat(priceCny) || 0;
                const R = parseFloat(rate) || 1;
                const W = parseFloat(weight) || 0;
                
                // 1. 商品金額 (台幣)
                const itemTwd = (P * qty) * R;
                
                // 2. 淘寶手續費 3%
                const tbFee = itemTwd * 0.03;
                
                // 3. 刷卡手續費 1.5%
                const cardFee = itemTwd * 0.015;
                
                // 4. 尊榮服務費 (若有)
                const premiumFee = hasPremium ? (itemTwd * (parseFloat(premiumRate)/100)) : 0;
                
                // 5. 關稅 (若有)
                const taxPerKg = getCategoryTax(category);
                const taxFee = hasTax ? (taxPerKg * W) : 0;
                
                // 6. 包材
                const pkgFee = 15;

                const total = itemTwd + tbFee + cardFee + premiumFee + taxFee + pkgFee;
                
                return {
                    total: Math.round(total),
                    breakdown: { itemTwd, tbFee, cardFee, premiumFee, taxFee, pkgFee }
                };
            }, [taobaoData, getCategoryTax]);

            const koreaLogistics = useMemo(() => mode === 'korea' ? calculateKoreaLogistics() : [], [koreaData, mode, calculateKoreaLogistics]);
            const taobaoResult = calculateTaobao;

            // Group Korea Logistics
            const koreaGroups = useMemo(() => {
                if(mode !== 'korea') return {};
                return koreaLogistics.reduce((acc, item) => {
                    if(!acc[item.group]) acc[item.group] = [];
                    acc[item.group].push(item);
                    return acc;
                }, {});
            }, [koreaLogistics, mode]);

            // Auto update total cost
            useEffect(() => {
                if (mode === 'taobao') {
                    setSellData(prev => ({ ...prev, totalCost: taobaoResult.total }));
                }
            }, [taobaoResult, mode]);

            // Profit Calcs
            const calcProfits = () => {
                const cost = parseFloat(sellData.totalCost) || 0;
                const margin = (parseFloat(sellData.marginPercent) || 50) / 100;
                const shipping = 60; // 預估運費
                const logisticsFeeGreen = 90; // 預估綠界物流成本

                const targetPrice = Math.round(cost * (1 + margin));
                
                // 簡化蝦皮費用計算 (僅為估算)
                const shopeeNormalFee = targetPrice * 0.06;
                const sysFee = targetPrice * 0.025;
                const preOrderFee = targetPrice * 0.03;
                const shopeeTotalFee = shopeeNormalFee + sysFee + preOrderFee;

                const shopeeProfit = targetPrice - cost - shopeeTotalFee - shipping;
                const shopeeRate = targetPrice > 0 ? (shopeeProfit / targetPrice) * 100 : 0;

                // 檔期費用率更高 (例如多 2%)
                const shopeeEventFee = targetPrice * 0.08;
                const shopeeEventTotalFee = shopeeEventFee + sysFee + preOrderFee;
                const shopeeEventProfit = targetPrice - cost - shopeeEventTotalFee - shipping;
                const shopeeEventRate = targetPrice > 0 ? (shopeeEventProfit / targetPrice) * 100 : 0;

                // 簡化綠界費用計算 (例如 3% 金流費)
                const greenFee = targetPrice * 0.03;
                const greenProfit = targetPrice - cost - greenFee - logisticsFeeGreen;
                const greenRate = targetPrice > 0 ? (greenProfit / targetPrice) * 100 : 0;

                return { targetPrice, shopeeProfit, shopeeRate, shopeeEventProfit, shopeeEventRate, greenProfit, greenRate };
            };

            const profits = calcProfits();

            return (
                <div className="space-y-6 animate-fade-in">
                    {/* Toggle */}
                    <div className="flex bg-white rounded-xl p-1 shadow-sm w-fit border border-[#E3D5CA]">
                        <button onClick={() => setMode('korea')} className={`px-4 py-2 rounded-lg transition-all font-bold ${mode === 'korea' ? 'bg-[#A4C3B2] text-white' : 'text-gray-400'}`}>韓國定價</button>
                        <button onClick={() => setMode('taobao')} className={`px-4 py-2 rounded-lg transition-all font-bold ${mode === 'taobao' ? 'bg-[#E5B3BB] text-white' : 'text-gray-400'}`}>淘寶定價</button>
                    </div>

                    <div className="grid lg:grid-cols-2 gap-6">
                        {/* INPUTS */}
                        <div className="card">
                            <h3 className="section-title text-sage-dark">
                                <Icons.Package size={20}/> 成本參數 ({mode === 'korea' ? 'KRW' : 'CNY'})
                            </h3>
                            <div className="space-y-4">
                                {mode === 'korea' ? (
                                    <>
                                        <div>
                                            <label className="text-xs font-bold text-gray-400">商品類別 (影響關稅)</label>
                                            <select className="input-field" value={koreaData.category} onChange={e => setKoreaData({...koreaData, category: e.target.value})}>
                                                {categories.map(c => <option key={c.name} value={c.name}>{c.name}</option>)}
                                            </select>
                                        </div>
                                        <div className="grid grid-cols-3 gap-4">
                                            <div>
                                                <label className="text-xs font-bold text-gray-400">採購價 (₩)</label>
                                                <input type="number" className="input-field" value={koreaData.priceWon} onChange={e => setKoreaData({...koreaData, priceWon: e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="text-xs font-bold text-gray-400">匯率</label>
                                                <input type="number" className="input-field" value={koreaData.rate} onChange={e => setKoreaData({...koreaData, rate: e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="text-xs font-bold text-gray-400">數量</label>
                                                <input type="number" className="input-field" value={koreaData.qty} onChange={e => setKoreaData({...koreaData, qty: e.target.value})} />
                                            </div>
                                            <div className="col-span-3">
                                                <label className="text-xs font-bold text-gray-400">重量 (kg)</label>
                                                <input type="number" step="0.1" className="input-field" value={koreaData.weight} onChange={e => setKoreaData({...koreaData, weight: e.target.value})} />
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="col-span-2">
                                                <label className="text-xs font-bold text-gray-400">商品類別 (影響關稅)</label>
                                                <select className="input-field" value={taobaoData.category} onChange={e => setTaobaoData({...taobaoData, category: e.target.value})}>
                                                    {categories.map(c => <option key={c.name} value={c.name}>{c.name}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-xs font-bold text-gray-400">採購價 (¥)</label>
                                                <input type="number" className="input-field" value={taobaoData.priceCny} onChange={e => setTaobaoData({...taobaoData, priceCny: e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="text-xs font-bold text-gray-400">匯率</label>
                                                <input type="number" className="input-field" value={taobaoData.rate} onChange={e => setTaobaoData({...taobaoData, rate: e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="text-xs font-bold text-gray-400">重量 (kg)</label>
                                                <input type="number" step="0.1" className="input-field" value={taobaoData.weight} onChange={e => setTaobaoData({...taobaoData, weight: e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="text-xs font-bold text-gray-400">數量</label>
                                                <input type="number" className="input-field" value={taobaoData.qty} onChange={e => setTaobaoData({...taobaoData, qty: e.target.value})} />
                                            </div>
                                        </div>
                                        
                                        {/* Toggles */}
                                        <div className="bg-milk-light p-3 rounded-xl space-y-3">
                                            <div className="flex items-center justify-between">
                                                <label className="flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" checked={taobaoData.hasPremium} onChange={e => setTaobaoData({...taobaoData, hasPremium: e.target.checked})} className="accent-[#E5B3BB] w-4 h-4"/>
                                                    <span className="text-sm font-bold text-gray-600">淘寶尊榮服務</span>
                                                </label>
                                                {taobaoData.hasPremium && (
                                                    <div className="flex items-center gap-1">
                                                        <input type="number" className="w-12 text-center border rounded p-1 text-sm" value={taobaoData.premiumRate} onChange={e => setTaobaoData({...taobaoData, premiumRate: e.target.value})} />
                                                        <span className="text-xs">%</span>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex items-center justify-between">
                                                <label className="flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" checked={taobaoData.hasTax} onChange={e => setTaobaoData({...taobaoData, hasTax: e.target.checked})} className="accent-[#E5B3BB] w-4 h-4"/>
                                                    <span className="text-sm font-bold text-gray-600">計算關稅</span>
                                                </label>
                                                {taobaoData.hasTax && (
                                                     <span className="text-xs text-gray-500 bg-white px-2 py-1 rounded">
                                                        {getCategoryTax(taobaoData.category)}/kg
                                                     </span>
                                                )}
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>

                            {/* RESULTS LIST */}
                            <div className="mt-6">
                                <h4 className="font-bold text-sm mb-2 text-gray-400">計算結果 (NT$)</h4>
                                <div className="bg-[#FFFBF5] rounded-xl border border-[#E3D5CA] max-h-80 overflow-y-auto no-scrollbar">
                                    {mode === 'korea' ? (
                                        <div className="p-2">
                                            {Object.keys(koreaGroups).map(group => (
                                                <div key={group} className="mb-3">
                                                    <div className="logistics-group-title">{group} 物流</div>
                                                    {koreaGroups[group].map(opt => (
                                                        <div key={opt.name} onClick={() => setSellData({...sellData, totalCost: opt.cost})} 
                                                            className="flex flex-col p-2.5 rounded-lg cursor-pointer hover:bg-white hover:shadow-sm border border-transparent hover:border-[#E3D5CA] transition-all mb-1 group">
                                                            <div className="flex justify-between items-center text-sm text-gray-600">
                                                                <span className="pl-2">{opt.name.replace(group, '')}</span>
                                                                <span className="font-bold text-[#6B8F7D]">${opt.cost}</span>
                                                            </div>
                                                            {/* Breakdown Row - 修正為顯示韓幣細項 */}
                                                            <div className="flex flex-wrap gap-x-3 gap-y-1 pl-2 mt-1 text-[10px] text-gray-400 opacity-80">
                                                                <span>商品: ₩{opt.breakdown.itemCostKRW}</span>
                                                                <span>運費: ₩{opt.breakdown.freightCostKRW.toFixed(0)}</span>
                                                                <span>代購: ₩{opt.breakdown.serviceFeeKRW.toFixed(0)}</span>
                                                                <span className="font-bold text-gray-600/80">總計 TWD: ${opt.breakdown.totalTWDFromKRW}</span>
                                                                {opt.breakdown.taxTWD > 0 && <span className="text-orange-400">關稅:${opt.breakdown.taxTWD}</span>}
                                                                <span>包材:${opt.breakdown.pkgTWD}</span>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="p-4 space-y-3">
                                            <div className="flex justify-between items-center text-xl font-bold text-[#E5B3BB]">
                                                <span>總成本</span>
                                                <span>${taobaoResult.total}</span>
                                            </div>
                                            <div className="border-t border-dashed border-[#E3D5CA] pt-2 space-y-1 text-xs text-gray-500">
                                                <div className="flex justify-between"><span>商品金額(含匯率)</span><span>${taobaoResult.breakdown.itemTwd.toFixed(0)}</span></div>
                                                <div className="flex justify-between"><span>淘寶手續費(3%)</span><span>${taobaoResult.breakdown.tbFee.toFixed(0)}</span></div>
                                                <div className="flex justify-between"><span>刷卡手續費(1.5%)</span><span>${taobaoResult.breakdown.cardFee.toFixed(0)}</span></div>
                                                {taobaoData.hasPremium && <div className="flex justify-between text-[#B5838D]"><span>尊榮服務費</span><span>${taobaoResult.breakdown.premiumFee.toFixed(0)}</span></div>}
                                                {taobaoData.hasTax && <div className="flex justify-between text-[#B5838D]"><span>關稅</span><span>${taobaoResult.breakdown.taxFee.toFixed(0)}</span></div>}
                                                <div className="flex justify-between"><span>包材費</span><span>${taobaoResult.breakdown.pkgFee}</span></div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* PRICING */}
                        <div className="card bg-gradient-to-br from-white to-[#F7EFE5]">
                            <h3 className="section-title text-pink-dark">
                                <Icons.TrendingUp size={20}/> 售價與利潤
                            </h3>
                            
                            <div className="mb-4">
                                <label className="text-xs font-bold text-gray-400">總成本 (NT$)</label>
                                <input type="number" className="input-field font-bold text-[#6B8F7D] text-lg" value={sellData.totalCost} onChange={e => setSellData({...sellData, totalCost: e.target.value})} />
                            </div>
                            
                            <div className="mb-6">
                                <label className="text-xs font-bold text-gray-400">利潤加成 (成本 x (1+?%))</label>
                                <div className="flex gap-2 mt-2">
                                    {[50, 60, 75].map(p => (
                                        <button key={p} onClick={() => setSellData({...sellData, marginPercent: p})}
                                            className={`px-3 py-1.5 rounded-full text-xs font-bold border transition-all ${sellData.marginPercent == p ? 'bg-[#E5B3BB] text-white border-[#E5B3BB]' : 'border-gray-300 text-gray-500 bg-white'}`}>
                                            {p}%
                                        </button>
                                    ))}
                                    <input type="number" className="w-20 px-2 py-1.5 rounded-full text-xs border border-gray-300 text-center focus:border-[#E5B3BB] outline-none" 
                                        value={sellData.marginPercent} onChange={e => setSellData({...sellData, marginPercent: e.target.value})} />
                                </div>
                            </div>

                            <div className="space-y-3">
                                <div className="p-4 bg-white rounded-2xl shadow-sm border border-[#E3D5CA] flex flex-col items-center">
                                    <div className="text-xs text-gray-400 font-bold tracking-widest mb-1">建議售價</div>
                                    <div className="text-3xl font-bold text-[#4A4A4A]">{formatCurrency(profits.targetPrice)}</div>
                                </div>

                                <div className="grid grid-cols-1 gap-2 text-sm mt-4">
                                    <div className="flex justify-between p-3 bg-white/60 rounded-xl border border-orange-100">
                                        <span className="text-orange-800 font-bold text-xs">蝦皮(非檔期)利潤</span>
                                        <span className="font-bold text-orange-600">{formatCurrency(profits.shopeeProfit)} ({profits.shopeeRate.toFixed(1)}%)</span>
                                    </div>
                                    <div className="flex justify-between p-3 bg-white/60 rounded-xl border border-red-100">
                                        <span className="text-red-800 font-bold text-xs">蝦皮(檔期)利潤</span>
                                        <span className="font-bold text-red-600">{formatCurrency(profits.shopeeEventProfit)} ({profits.shopeeEventRate.toFixed(1)}%)</span>
                                    </div>
                                    <div className="flex justify-between p-3 bg-white/60 rounded-xl border border-green-100">
                                        <span className="text-green-800 font-bold text-xs">綠界利潤</span>
                                        <span className="font-bold text-green-600">{formatCurrency(profits.greenProfit)} ({profits.greenRate.toFixed(1)}%)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. Product Form
        const ProductForm = ({ gender, onCancel, onSuccess, initialData = null, showToast }) => {
            const [formData, setFormData] = useState(() => ({
                sku: '', image: '', weight: '', madeIn: 'Korea', date: new Date().toISOString().split('T')[0], // date is assumed as 檔口上新日期
                vendor: '', name: '', shopeeName: '', listingDate: '', currency: 'KRW',
                originalCost: 0, costTwd: 0, setCostTwd: 0,
                originalPrice: 0, promoPrice: 0, 
                setOriginalPrice: 0, setPromoPrice: 0,
                stock: 0,
                note: '',
                ...(initialData || {}) // Merge initial data if available
            }));
            const [loading, setLoading] = useState(false);

            // Auto calculate raw profits (used in form display only)
            const shopeeProfit = formData.promoPrice - formData.costTwd;
            const setProfit = formData.setPromoPrice - formData.setCostTwd;

            const handleImage = (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Check file size limit (800KB)
                    if (file.size > 800000) {
                        showToast("圖片過大，請使用小於 800KB 的圖片", 'error');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setFormData({...formData, image: reader.result});
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleSubmit = async () => {
                // Soft validation: SKU and Name are highly recommended identifiers
                if (!formData.sku || !formData.name) {
                    showToast("警告：SKU 或商品名稱為空，請填寫以利追蹤！", 'info');
                }
                
                setLoading(true);
                try {
                    // Firestore path uses the public data collection structure
                    const collectionName = `/artifacts/${appId}/public/data/${gender === 'men' ? 'products_men' : 'products_women'}`;

                    if (initialData && initialData.id) {
                        await db.collection(collectionName).doc(initialData.id).update(formData);
                    } else {
                        await db.collection(collectionName).add({ ...formData, createdAt: new Date() });
                    }
                    showToast(initialData ? '產品資料更新成功！' : '產品資料新增成功！', 'success');
                    onSuccess();
                } catch (error) {
                    console.error("Error saving product:", error);
                    showToast("儲存失敗，請檢查網路或重試。", 'error');
                }
                setLoading(false);
            };

            return (
                <div className="card animate-slide-up">
                    <h2 className="text-2xl font-bold mb-6 text-sage-dark">{initialData ? '修改商品' : '新增商品'} ({gender === 'men' ? '男裝' : '女裝'})</h2>
                    
                    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                        <div className="col-span-1 lg:col-span-1 row-span-2">
                            <label className="block mb-2 font-bold text-gray-500">商品圖片</label>
                            <div className="border-2 border-dashed border-[#E3D5CA] rounded-xl h-48 flex items-center justify-center relative overflow-hidden bg-cream group hover:border-[#A4C3B2] transition-colors">
                                {formData.image ? (
                                    <img src={formData.image} className="w-full h-full object-cover" />
                                ) : (
                                    <span className="text-gray-400 group-hover:text-[#A4C3B2]">點擊上傳</span>
                                )}
                                <input type="file" accept="image/jpeg, image/png" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleImage} />
                            </div>
                        </div>

                        <div><label className="font-bold text-gray-500">SKU (上架商品號)</label><input className="input-field" value={formData.sku} onChange={e=>setFormData({...formData, sku: e.target.value})} /></div>
                        <div><label className="font-bold text-gray-500">商品名稱 (檔口品名)</label><input className="input-field" value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value})} /></div>
                        <div><label className="font-bold text-gray-500">蝦皮中文品名</label><input className="input-field" value={formData.shopeeName} onChange={e=>setFormData({...formData, shopeeName: e.target.value})} /></div>
                        <div><label className="font-bold text-gray-500">檔口 (廠商)</label><input className="input-field" value={formData.vendor} onChange={e=>setFormData({...formData, vendor: e.target.value})} /></div>
                        <div><label className="font-bold text-gray-500">預估重量 (kg)</label><input type="number" className="input-field" value={formData.weight} onChange={e=>setFormData({...formData, weight: e.target.value})} /></div>
                        <div><label className="font-bold text-gray-500">Made in</label><input className="input-field" value={formData.madeIn} onChange={e=>setFormData({...formData, madeIn: e.target.value})} /></div>
                        
                        <div className="lg:col-span-3 border-t border-[#E3D5CA] my-2"></div>
                        <h4 className="lg:col-span-3 font-bold text-pink-dark">成本與定價</h4>
                        
                        <div><label className="font-bold text-gray-500">檔口上新日期</label><input type="date" className="input-field" value={formData.date} onChange={e=>setFormData({...formData, date: e.target.value})} /></div>
                        <div><label className="font-bold text-gray-500">上架日期</label><input type="date" className="input-field" value={formData.listingDate} onChange={e=>setFormData({...formData, listingDate: e.target.value})} /></div>
                        <div>
                            <label className="font-bold text-gray-500">成本幣別</label>
                            <select className="input-field" value={formData.currency} onChange={e=>setFormData({...formData, currency: e.target.value})}>
                                <option value="KRW">韓幣 (₩)</option>
                                <option value="CNY">人民幣 (¥)</option>
                                <option value="TWD">台幣 (NT$)</option>
                            </select>
                        </div>
                        <div><label className="font-bold text-gray-500">單品原始成本</label><input type="number" className="input-field" value={formData.originalCost} onChange={e=>setFormData({...formData, originalCost: e.target.value})} /></div>
                        <div><label className="font-bold text-gray-500">單品成本 (TWD)</label><input type="number" className="input-field bg-yellow-50" value={formData.costTwd} onChange={e=>setFormData({...formData, costTwd: e.target.value})} /></div>
                        
                        <div><label className="font-bold text-gray-500">單品原價</label><input type="number" className="input-field" value={formData.originalPrice} onChange={e=>setFormData({...formData, originalPrice: e.target.value})} /></div>
                        <div><label className="font-bold text-gray-500">單品優惠價</label><input type="number" className="input-field" value={formData.promoPrice} onChange={e=>setFormData({...formData, promoPrice: e.target.value})} /></div>
                        <div><label className="font-bold text-gray-500">預估利潤 (簡)</label><div className="p-2 text-green-600 font-bold">{formatCurrency(shopeeProfit)}</div></div>

                        <div className="lg:col-span-3 border-t border-[#E3D5CA] my-2"></div>
                        <h4 className="lg:col-span-3 font-bold text-sage-dark">套裝設定 (選填)</h4>

                        <div><label className="font-bold text-gray-500">套裝總成本 (TWD)</label><input type="number" className="input-field bg-yellow-50" value={formData.setCostTwd} onChange={e=>setFormData({...formData, setCostTwd: e.target.value})} /></div>
                        <div><label className="font-bold text-gray-500">套裝原價</label><input type="number" className="input-field" value={formData.setOriginalPrice} onChange={e=>setFormData({...formData, setOriginalPrice: e.target.value})} /></div>
                        <div><label className="font-bold text-gray-500">套裝優惠價</label><input type="number" className="input-field" value={formData.setPromoPrice} onChange={e=>setFormData({...formData, setPromoPrice: e.target.value})} /></div>
                        <div><label className="font-bold text-gray-500">預估套裝利潤 (簡)</label><div className="p-2 text-green-600 font-bold">{formatCurrency(setProfit)}</div></div>

                        <div className="lg:col-span-3">
                            <label className="font-bold text-gray-500">備註 / 細節</label>
                            <textarea className="input-field" rows="2" value={formData.note} onChange={e=>setFormData({...formData, note: e.target.value})}></textarea>
                        </div>
                    </div>

                    <div className="flex justify-end gap-4 mt-6">
                        <button onClick={onCancel} className="px-6 py-2 rounded-xl border border-gray-300 text-gray-500 hover:bg-gray-50 font-bold">取消</button>
                        <button onClick={handleSubmit} disabled={loading} className="btn-primary">
                            {loading ? '儲存中...' : '儲存產品資料'}
                        </button>
                    </div>
                </div>
            );
        };

        // 3. Product List
        const ProductList = ({ gender, onEdit, showToast }) => {
            const [products, setProducts] = useState([]);
            const [filter, setFilter] = useState('');
            const [deletingId, setDeletingId] = useState(null); // State for inline deletion confirmation
            
            useEffect(() => {
                // Firestore path uses the public data collection structure
                const collectionPath = `/artifacts/${appId}/public/data/${gender === 'men' ? 'products_men' : 'products_women'}`;
                
                // 檢查 auth.currentUser 是否存在，確保 userId 可用 (雖然匿名登入通常會立即提供)
                const unsubscribe = db.collection(collectionPath).orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                    setProducts(snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})));
                }, (error) => {
                    console.error("Firestore onSnapshot error:", error);
                    showToast('資料載入失敗，請檢查權限或網路連接。', 'error');
                });
                
                return () => unsubscribe();
            }, [gender]);

            const filteredProducts = products.filter(p => 
                (p.sku && p.sku.toLowerCase().includes(filter.toLowerCase())) || 
                (p.name && p.name.toLowerCase().includes(filter.toLowerCase()))
            );

            const confirmDelete = (id) => {
                setDeletingId(id);
                setTimeout(() => setDeletingId(null), 5000); // Auto cancel confirmation after 5 seconds
            }

            const executeDelete = async (id) => {
                setDeletingId(null);
                try {
                    const collectionPath = `/artifacts/${appId}/public/data/${gender === 'men' ? 'products_men' : 'products_women'}`;
                    await db.collection(collectionPath).doc(id).delete();
                    showToast('商品已刪除', 'success');
                } catch (error) {
                    console.error("Error deleting product:", error);
                    showToast('刪除失敗', 'error');
                }
            };

            const handleStockUpdate = async (id, currentStock, newVal) => {
                const newStock = Number(newVal);
                if (newStock === currentStock) return;
                
                try {
                    const collectionPath = `/artifacts/${appId}/public/data/${gender === 'men' ? 'products_men' : 'products_women'}`;
                    await db.collection(collectionPath).doc(id).update({ stock: newStock });
                    showToast(`庫存更新為 ${newStock}`, 'success');
                } catch (error) {
                     console.error("Error updating stock:", error);
                     showToast('庫存更新失敗', 'error');
                }
            };

            const exportToExcel = () => {
                const dataToExport = filteredProducts.map(p => {
                    // 計算單品利潤
                    const singleShopeeProfit = calculateEstimatedProfit(p.promoPrice, p.costTwd, SHOPEE_FEE_RATE);
                    const singleEcommerceProfit = calculateEstimatedProfit(p.promoPrice, p.costTwd, ECOMMERCE_FEE_RATE);

                    // 計算套裝利潤
                    const setShopeeProfit = calculateEstimatedProfit(p.setPromoPrice, p.setCostTwd, SHOPEE_FEE_RATE);
                    const setEcommerceProfit = calculateEstimatedProfit(p.setPromoPrice, p.setCostTwd, ECOMMERCE_FEE_RATE);

                    return {
                        '上架商品號 (SKU)': p.sku,
                        '產品圖上傳': p.image ? '已上傳' : '未上傳',
                        '預估重量 (kg)': p.weight,
                        'Made in': p.madeIn,
                        '檔口上新日期': p.date, 
                        '檔口 (廠商名稱)': p.vendor,
                        '商品名稱 (檔口品名)': p.name,
                        '蝦皮中文品名': p.shopeeName,
                        '上架日期': p.listingDate,
                        '檔口成本幣別': p.currency,
                        '單品原始成本價': p.originalCost,
                        '單品成本價 (TWD)': p.costTwd,
                        '套裝總成本 (TWD)': p.setCostTwd,

                        // 單品 - 蝦皮價格與利潤 (14-16)
                        '單品_蝦皮_原價': p.originalPrice,
                        '單品_蝦皮_優惠價': p.promoPrice,
                        '單品_蝦皮_預估利潤 (TWD)': singleShopeeProfit,

                        // 單品 - 綠界價格與利潤 (17-19)
                        '單品_綠界_原價': p.originalPrice,
                        '單品_綠界_優惠價': p.promoPrice,
                        '單品_綠界_預估利潤 (TWD)': singleEcommerceProfit,

                        // 套裝 - 蝦皮價格與利潤 (20-22)
                        '套裝_蝦皮_原價': p.setOriginalPrice,
                        '套裝_蝦皮_優惠價': p.setPromoPrice,
                        '套裝_蝦皮_預估利潤 (TWD)': setShopeeProfit,

                        // 套裝 - 綠界價格與利潤 (23-25)
                        '套裝_綠界_原價': p.setOriginalPrice,
                        '套裝_綠界_優惠價': p.setPromoPrice,
                        '套裝_綠界_預估利潤 (TWD)': setEcommerceProfit,
                        
                        '備註 / 細節': p.note
                    };
                });

                // 26個欄位定義，用於確保順序
                const headers = [
                    '上架商品號 (SKU)',
                    '產品圖上傳',
                    '預估重量 (kg)',
                    'Made in',
                    '檔口上新日期',
                    '檔口 (廠商名稱)',
                    '商品名稱 (檔口品名)',
                    '蝦皮中文品名',
                    '上架日期',
                    '檔口成本幣別',
                    '單品原始成本價',
                    '單品成本價 (TWD)',
                    '套裝總成本 (TWD)',
                    '單品_蝦皮_原價',
                    '單品_蝦皮_優惠價',
                    '單品_蝦皮_預估利潤 (TWD)',
                    '單品_綠界_原價',
                    '單品_綠界_優惠價',
                    '單品_綠界_預估利潤 (TWD)',
                    '套裝_蝦皮_原價',
                    '套裝_蝦皮_優惠價',
                    '套裝_蝦皮_預估利潤 (TWD)',
                    '套裝_綠界_原價',
                    '套裝_綠界_優惠價',
                    '套裝_綠界_預估利潤 (TWD)',
                    '備註 / 細節'
                ];

                const ws = XLSX.utils.json_to_sheet(dataToExport, { header: headers });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Products");
                XLSX.writeFile(wb, `MS_${gender}_Products_${new Date().toISOString().slice(0,10)}.xlsx`);
            };

            return (
                <div className="card">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div className="relative w-full md:w-1/3">
                            <Icons.Search className="absolute left-3 top-2.5 text-gray-400" size={18} />
                            <input 
                                type="text" 
                                placeholder="搜尋品名或 SKU..." 
                                className="input-field pl-10"
                                value={filter}
                                onChange={e => setFilter(e.target.value)}
                            />
                        </div>
                        <button onClick={exportToExcel} className="btn-secondary text-sm">
                            <Icons.Download size={16}/> 匯出 Excel
                        </button>
                    </div>

                    <div className="overflow-x-auto rounded-xl border border-[#E3D5CA]">
                        <table className="w-full text-left text-sm">
                            <thead className="table-header">
                                <tr>
                                    <th className="p-4">圖片</th>
                                    <th className="p-4">SKU</th>
                                    <th className="p-4">名稱</th>
                                    <th className="p-4">廠商</th>
                                    <th className="p-4">庫存</th>
                                    <th className="p-4">成本 (TWD)</th>
                                    <th className="p-4">售價</th>
                                    <th className="p-4 text-center">操作</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-[#F7EFE5]">
                                {filteredProducts.map(p => (
                                    <tr key={p.id} className="hover:bg-[#F7EFE5]/50 transition-colors bg-white">
                                        <td className="p-4">
                                            {p.image ? <img src={p.image} className="w-12 h-12 object-cover rounded-xl shadow-sm" /> : <div className="w-12 h-12 bg-gray-100 rounded-xl"></div>}
                                        </td>
                                        <td className="p-4 font-bold text-sage-dark">{p.sku}</td>
                                        <td className="p-4 text-gray-700">{p.name}</td>
                                        <td className="p-4 text-gray-400">{p.vendor}</td>
                                        <td className="p-4">
                                            <input type="number" className="w-16 p-1.5 border border-gray-200 rounded-lg text-center bg-white focus:ring-1 focus:ring-sage-dark outline-none" 
                                                defaultValue={p.stock} 
                                                onBlur={(e) => handleStockUpdate(p.id, p.stock, e.target.value)} />
                                        </td>
                                        <td className="p-4 font-medium">${p.costTwd}</td>
                                        <td className="p-4 font-medium">${p.promoPrice}</td>
                                        <td className="p-4 text-center">
                                            <div className="flex justify-center gap-3">
                                                <button onClick={() => onEdit(p)} className="flex items-center gap-1 text-[#6B8F7D] hover:text-[#4A6356] font-bold text-xs bg-[#E8F3EE] px-2 py-1 rounded-lg">
                                                    <Icons.Edit size={14}/> 修改
                                                </button>
                                                
                                                {deletingId === p.id ? (
                                                    <div className="flex gap-1">
                                                        <button onClick={() => executeDelete(p.id)} className="flex items-center gap-1 text-white hover:bg-red-700 font-bold text-xs bg-red-500 px-2 py-1 rounded-lg">
                                                            確認刪除
                                                        </button>
                                                        <button onClick={() => setDeletingId(null)} className="flex items-center gap-1 text-gray-500 hover:bg-gray-200 font-bold text-xs bg-white border border-gray-300 px-2 py-1 rounded-lg">
                                                            取消
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <button onClick={() => confirmDelete(p.id)} className="flex items-center gap-1 text-[#B5838D] hover:text-[#945D68] font-bold text-xs bg-[#F9EAEB] px-2 py-1 rounded-lg">
                                                        <Icons.Trash size={14}/> 刪除
                                                    </button>
                                                )}
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // 4. Inventory Log System
        const InventorySystem = ({ gender, showToast }) => {
            const [logs, setLogs] = useState([]);
            const [entry, setEntry] = useState({ skuOrName: '', type: 'IN', qty: 1 });
            const [message, setMessage] = useState('');

            // Firestore path uses the public data collection structure
            const logCollectionPath = `/artifacts/${appId}/public/data/${gender === 'men' ? 'inventory_logs_men' : 'inventory_logs_women'}`;
            const prodCollectionPath = `/artifacts/${appId}/public/data/${gender === 'men' ? 'products_men' : 'products_women'}`;

            useEffect(() => {
                const unsubscribe = db.collection(logCollectionPath).orderBy('timestamp', 'desc').limit(50).onSnapshot(snap => {
                    setLogs(snap.docs.map(doc => ({id: doc.id, ...doc.data()})));
                }, (error) => {
                    console.error("Firestore log snapshot error:", error);
                });
                return () => unsubscribe();
            }, [gender]);

            const handleLogSubmit = async () => {
                if (!entry.skuOrName || !Number(entry.qty) || Number(entry.qty) <= 0) {
                    showToast('請填寫商品識別碼與有效數量 (數量需大於 0)', 'error');
                    return;
                }
                setMessage('處理中...');
                
                try {
                    const logData = {
                        ...entry,
                        timestamp: new Date(),
                        dateStr: new Date().toLocaleString()
                    };
                    // 1. 記錄 Log
                    await db.collection(logCollectionPath).add(logData);

                    let productRef = null;
                    let currentStock = 0;
                    let productName = entry.skuOrName;
                    
                    // 2. 查找產品 (先找 SKU，再找 Name)
                    let q = await db.collection(prodCollectionPath).where('sku', '==', entry.skuOrName).get();
                    if (q.empty) {
                        q = await db.collection(prodCollectionPath).where('name', '==', entry.skuOrName).get();
                    }

                    if (!q.empty) {
                        const doc = q.docs[0];
                        productRef = doc.ref;
                        currentStock = Number(doc.data().stock) || 0;
                        productName = doc.data().name;

                        const change = entry.type === 'IN' ? Number(entry.qty) : -Number(entry.qty);
                        const newStock = currentStock + change;

                        if (newStock < 0) {
                            setMessage(`警告：庫存不足 (當前: ${currentStock})，操作已記錄但產品庫存未更新。`);
                            showToast('庫存不足，操作已記錄但產品庫存未更新。', 'info');
                            // 不更新產品庫存，僅記錄 Log
                        } else {
                            // 3. 更新庫存
                            await productRef.update({ stock: newStock });
                            setMessage(`成功：已記錄並更新庫存 (${productName} 目前: ${newStock})`);
                        }
                    } else {
                        setMessage(`成功：已記錄 (未找到匹配商品，僅保存紀錄)`);
                    }
                    setEntry({ ...entry, skuOrName: '', qty: 1 });
                } catch (e) {
                    console.error("Error logging inventory:", e);
                    setMessage('錯誤：操作失敗');
                    showToast('庫存操作失敗', 'error');
                }
                setTimeout(() => setMessage(''), 3000);
            };

            const exportLogs = () => {
                const ws = XLSX.utils.json_to_sheet(logs.map(log => ({
                    時間: log.dateStr,
                    識別碼: log.skuOrName,
                    動作: log.type,
                    數量: log.qty
                })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Logs");
                XLSX.writeFile(wb, `Stock_Logs_${gender}_${new Date().toISOString().slice(0,10)}.xlsx`);
            };

            return (
                <div className="space-y-6">
                    <div className="card bg-gradient-to-r from-[#F7EFE5] to-white border-none">
                        <h3 className="section-title text-[#6B6B6B]"><Icons.History/> 快速進出貨紀錄</h3>
                        <div className="flex flex-col md:flex-row gap-4 items-end">
                            <div className="flex-1 w-full">
                                <label className="text-xs font-bold text-gray-500">商品 SKU 或 品名</label>
                                <input className="input-field border-white shadow-sm" value={entry.skuOrName} onChange={e => setEntry({...entry, skuOrName: e.target.value})} placeholder="輸入識別碼..." />
                            </div>
                            <div className="w-32">
                                <label className="text-xs font-bold text-gray-500">類型</label>
                                <select className="input-field border-white shadow-sm" value={entry.type} onChange={e => setEntry({...entry, type: e.target.value})}>
                                    <option value="IN">進貨 (IN)</option>
                                    <option value="OUT">出貨 (OUT)</option>
                                </select>
                            </div>
                            <div className="w-24">
                                <label className="text-xs font-bold text-gray-500">數量</label>
                                <input type="number" className="input-field border-white shadow-sm" value={entry.qty} onChange={e => setEntry({...entry, qty: e.target.value})} />
                            </div>
                            <button onClick={handleLogSubmit} className="btn-primary h-[46px]">提交</button>
                        </div>
                        {message && <div className="mt-2 text-sm font-bold text-sage-dark">{message}</div>}
                    </div>

                    <div className="card">
                        <div className="flex justify-between mb-4">
                            <h3 className="font-bold text-gray-500">近期紀錄</h3>
                            <button onClick={exportLogs} className="text-xs text-sage-dark font-bold underline">匯出紀錄</button>
                        </div>
                        <div className="overflow-x-auto rounded-xl border border-[#E3D5CA]">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="text-gray-400 border-b border-gray-100 table-header">
                                        <th className="text-left py-2 px-4">時間</th>
                                        <th className="text-left py-2 px-4">識別碼</th>
                                        <th className="text-left py-2 px-4">動作</th>
                                        <th className="text-right py-2 px-4">數量</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {logs.map(log => (
                                        <tr key={log.id} className="border-b border-gray-50 last:border-0 hover:bg-[#F7EFE5]/50 transition-colors bg-white">
                                            <td className="py-2 px-4 text-gray-400 text-xs">{log.dateStr}</td>
                                            <td className="py-2 px-4 font-medium text-gray-700">{log.skuOrName}</td>
                                            <td className="py-2 px-4">
                                                <span className={`px-2 py-0.5 rounded text-xs font-bold ${log.type === 'IN' ? 'bg-[#E8F3EE] text-[#6B8F7D]' : 'bg-[#F9EAEB] text-[#B5838D]'}`}>
                                                    {log.type}
                                                </span>
                                            </td>
                                            <td className="py-2 px-4 text-right text-gray-600">{log.qty}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [user, setUser] = useState(null);
            const [genderTab, setGenderTab] = useState('men');
            const [view, setView] = useState('list');
            const [editingProduct, setEditingProduct] = useState(null);

            // --- Toast Message Logic ---
            const [toast, setToast] = useState({ message: '', type: '', visible: false });

            const showToast = useCallback((message, type = 'info') => {
                setToast({ message, type, visible: true });
                setTimeout(() => setToast(prev => ({ ...prev, visible: false })), 3000);
            }, []);

            const ToastDisplay = () => (
                <div className={`fixed bottom-4 right-4 p-4 rounded-xl shadow-lg text-white transition-opacity duration-300 z-50
                    ${toast.visible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4 pointer-events-none'} 
                    ${toast.type === 'error' ? 'bg-red-500' : toast.type === 'success' ? 'bg-[#A4C3B2]' : 'bg-gray-700'}`}>
                    {toast.message}
                </div>
            );
            // --- End Toast Message Logic ---
            
            // --- Firebase Auth Initialization ---
            useEffect(() => {
                const initializeAuth = async () => {
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    try {
                        if (initialAuthToken) {
                            await auth.signInWithCustomToken(initialAuthToken);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                        // Fallback to anonymous sign-in if custom token fails
                        try {
                             await auth.signInAnonymously();
                        } catch (anonError) {
                            console.error("Anonymous Sign-In Failed:", anonError);
                            showToast("認證失敗，請重新載入。", 'error');
                        }
                    }

                    auth.onAuthStateChanged((currentUser) => {
                        setUser(currentUser);
                        // 確保 Icon 在組件載入後被建立
                        lucide.createIcons(); 
                    });
                };
                
                initializeAuth();
            }, []);

            useEffect(() => {
                // 確保在 View 或 Tab 改變時 Icon 被重新建立
                lucide.createIcons();
            }, [view, genderTab]);

            const handleEdit = (product) => {
                setEditingProduct(product);
                setView('add');
            };

            // 確保用戶認證完成後才顯示應用程式內容
            if (!user) return <div className="h-screen flex items-center justify-center bg-cream text-sage-dark font-bold text-xl">系統載入中...</div>;

            return (
                <div className="min-h-screen pb-20 md:pb-0">
                    {/* Header */}
                    <header className={`p-6 ${genderTab === 'men' ? 'bg-[#4A6356]' : 'bg-[#945D68]'} text-white shadow-lg transition-colors duration-500`}>
                        <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center">
                            <h1 className="text-2xl font-bold flex items-center gap-2 tracking-widest">
                                <Icons.Shirt /> MS 服飾管理系統
                            </h1>
                            <div className="flex bg-white/20 p-1 rounded-full mt-4 md:mt-0 backdrop-blur-md">
                                <button onClick={() => setGenderTab('men')} 
                                    className={`px-6 py-1.5 rounded-full transition-all text-sm font-bold ${genderTab === 'men' ? 'bg-white text-[#4A6356] shadow' : 'text-white hover:bg-white/10'}`}>
                                    男裝 Men
                                </button>
                                <button onClick={() => setGenderTab('women')} 
                                    className={`px-6 py-1.5 rounded-full transition-all text-sm font-bold ${genderTab === 'women' ? 'bg-white text-[#945D68] shadow' : 'text-white hover:bg-white/10'}`}>
                                    女裝 Women
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-6xl mx-auto p-4 md:p-8">
                        
                        {/* Functional Tabs */}
                        <div className="flex flex-wrap gap-3 mb-8">
                            {[
                                { id: 'list', icon: Icons.Package, label: '商品列表' },
                                { id: 'add', icon: Icons.Plus, label: '新增/編輯' },
                                { id: 'calc', icon: Icons.Calculator, label: '價格計算' },
                                { id: 'logs', icon: Icons.History, label: '進貨紀錄' }
                            ].map(tab => (
                                <button key={tab.id} onClick={() => {setView(tab.id); if(tab.id!=='add') setEditingProduct(null);}} 
                                    className={`px-5 py-2.5 rounded-2xl flex items-center gap-2 transition-all font-bold tracking-wide ${view === tab.id ? 'bg-white shadow-md border border-[#E3D5CA] text-sage-dark transform -translate-y-0.5' : 'text-gray-400 hover:bg-white hover:text-gray-500'}`}>
                                    <tab.icon size={18}/> {tab.label}
                                </button>
                            ))}
                        </div>

                        {/* Views */}
                        <div className="transition-opacity duration-300">
                            {view === 'list' && <ProductList gender={genderTab} onEdit={handleEdit} showToast={showToast} />}
                            
                            {view === 'add' && (
                                <ProductForm 
                                    gender={genderTab} 
                                    initialData={editingProduct} 
                                    onCancel={() => {setEditingProduct(null); setView('list');}} 
                                    onSuccess={() => {setEditingProduct(null); setView('list');}} 
                                    showToast={showToast}
                                />
                            )}
                            
                            {view === 'calc' && <Calculator />}
                            
                            {view === 'logs' && <InventorySystem gender={genderTab} showToast={showToast} />}
                        </div>

                    </main>
                    
                    <footer className="text-center text-gray-400 text-xs py-10 font-bold tracking-widest">
                        MS Management System © 2025 (User ID: {user.uid})
                    </footer>

                    {/* Toast Message Display */}
                    <ToastDisplay />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>