<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY_STYLE 產品管理系統 - 套裝分流利潤版</title>
    <!-- Tailwind CSS (樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome (圖示) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SheetJS (Excel 匯出工具) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @-webkit-keyframes spinner { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* 隱藏數字輸入框的上下箭頭 (Spinner) */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- 系統初始設定視窗已移除，設定碼已直接嵌入程式碼中 -->

    <!-- 主介面 -->
    <!-- 移除 hidden，讓應用程式在初始化後直接顯示 -->
    <div id="app" class="min-h-screen flex flex-col">
        <!-- 導航列 -->
        <nav class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <i class="fas fa-tshirt text-indigo-600 text-2xl mr-3"></i>
                        <span class="font-bold text-xl tracking-tight text-gray-900">MY_STYLE 產品管理系統</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="clearLocalConfig()" class="text-gray-400 hover:text-red-500 text-sm">重置設定</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- 統計與操作區 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white overflow-hidden shadow rounded-lg p-5 border-l-4 border-indigo-500">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-indigo-100 rounded-md p-3">
                            <i class="fas fa-box text-indigo-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">目前產品總數</dt>
                                <dd class="flex items-baseline">
                                    <div id="total-count" class="text-2xl font-semibold text-gray-900">0</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow rounded-lg p-5 border-l-4 border-green-500">
                    <button onclick="openModal('add')" class="w-full h-full flex items-center justify-center text-green-600 hover:text-green-800 transition">
                        <i class="fas fa-plus-circle text-2xl mr-2"></i>
                        <span class="text-lg font-bold">新增產品資料</span>
                    </button>
                </div>

                <div class="bg-white overflow-hidden shadow rounded-lg p-5 border-l-4 border-yellow-500">
                    <button onclick="exportToExcel()" class="w-full h-full flex items-center justify-center text-yellow-600 hover:text-yellow-800 transition">
                        <i class="fas fa-file-excel text-2xl mr-2"></i>
                        <span class="text-lg font-bold">匯出 Excel (備份)</span>
                    </button>
                </div>
            </div>

            <!-- 產品列表 -->
            <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6 flex justify-between items-center bg-gray-50 border-b border-gray-200">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">產品清單</h3>
                    <div class="relative">
                        <input type="text" id="search-input" onkeyup="filterProducts()" placeholder="搜尋編號或名稱..." class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-64 sm:text-sm border-gray-300 rounded-md p-2 pl-3">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">圖片</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">編號 (SKU)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">蝦皮中文品名</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">單品成本</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">蝦皮優惠價</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-indigo-700">預估蝦皮利潤</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-green-700">預估綠界利潤</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-cyan-700">蝦皮套裝利潤</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-purple-700">綠界套裝利潤</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="product-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- 資料將由 JS 插入 -->
                        </tbody>
                    </table>
                    <div id="loading-spinner" class="py-10 flex justify-center hidden">
                        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增/編輯視窗 (不變) -->
    <div id="product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full z-40">
        <div class="relative top-5 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white mb-10">
            <div class="mt-2">
                <h3 class="text-lg leading-6 font-bold text-gray-900 mb-4 border-b pb-2" id="modal-title">新增產品</h3>
                <form id="product-form" onsubmit="handleFormSubmit(event)">
                    <input type="hidden" id="doc-id">
                    <input type="hidden" id="existing_image_url">
                    
                    <!-- 第一區：基本識別與圖片 -->
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-4">
                        <div class="md:col-span-4">
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="sku">1. 上架商品號 (SKU)</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="sku" type="text" placeholder="例如: MS-00001" required>
                        </div>
                        <div class="md:col-span-8">
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="image_file">2. 產品圖上傳 (僅支援 JPG/PNG)</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white" id="image_file" type="file" accept="image/jpeg, image/png" onchange="previewImage(event)">
                            <div id="image-preview-container" class="mt-2 text-center border border-dashed border-gray-300 rounded p-2 hidden">
                                <img id="image-preview" class="max-h-40 mx-auto rounded object-contain" src="" alt="圖片預覽">
                                <p id="current-image-name" class="text-xs text-gray-500 mt-1"></p>
                            </div>
                        </div>
                    </div>

                    <!-- 第二區：規格與來源 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 bg-gray-50 p-3 rounded">
                        <div>
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="weight_g">3. 預估重量 (g)</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="weight_g" type="number" placeholder="單位: g">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="made_in">4. Made in</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="made_in" type="text" placeholder="例如: KOREA">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="vendor_new_date">5. 檔口上新日期</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="vendor_new_date" type="date">
                        </div>
                    </div>

                    <!-- 第三區：檔口與品名資訊 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="vendor_shop_name">6. 檔口 (廠商名稱)</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="vendor_shop_name" type="text" placeholder="檔口名字">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="vendor_product_name">7. 商品名稱 (檔口品名)</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="vendor_product_name" type="text" placeholder="檔口提供的商品名稱">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                         <div class="md:col-span-2">
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="shopee_name_zh">8. 蝦皮中文品名</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="shopee_name_zh" type="text" placeholder="蝦皮上架用的主標題">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="listing_date">9. 上架日期</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="listing_date" type="date">
                        </div>
                    </div>

                    <!-- 第四區：成本 (黃色背景強調) - 新增套裝成本 (12.) -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 bg-yellow-50 p-3 rounded border border-yellow-200">
                        <div class="md:col-span-1">
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="cost_currency">10. 韓幣/人民幣 (幣別)</label>
                            <select class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="cost_currency">
                                <option value="KRW">韓幣 (₩)</option>
                                <option value="RMB">人民幣 (¥)</option>
                            </select>
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="cost_value">11. 單品成本價 (TWD)</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline border-yellow-400 font-bold" id="cost_value" type="number" placeholder="單品 TWD 成本" oninput="calculateEstimatedProfit()">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="bundle_cost_value">12. 套裝總成本 (TWD)</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline border-yellow-400 font-bold" id="bundle_cost_value" type="number" placeholder="套裝 TWD 總成本" oninput="calculateEstimatedProfit()">
                            <p class="text-xs text-gray-500 mt-1">例如：上衣成本 + 褲子成本</p>
                        </div>
                    </div>

                    <!-- 第五區：單品售價策略 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- 蝦皮區塊 (單品 - 編號 13-16) -->
                        <div class="border p-3 rounded bg-indigo-50 border-indigo-100">
                            <p class="text-xs font-bold text-indigo-800 mb-2 text-center border-b border-indigo-200 pb-1">單品 - 蝦皮價格與利潤</p>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-gray-600 text-xs mb-1" for="shopee_price_orig">13. 原價</label>
                                    <input class="shadow appearance-none border rounded w-full py-1 px-2 text-sm" id="shopee_price_orig" type="number">
                                </div>
                                <div>
                                    <label class="block text-gray-600 text-xs mb-1" for="shopee_price_discount">14. 優惠價</label>
                                    <input class="shadow appearance-none border border-indigo-400 rounded w-full py-1 px-2 text-sm font-bold" id="shopee_price_discount" type="number" oninput="calculateEstimatedProfit()">
                                </div>
                            </div>
                            
                            <!-- 15. 預估蝦皮單品利潤 -->
                            <div class="pt-2 border-t border-indigo-200 mt-3">
                                <label class="block text-gray-700 text-xs font-bold mb-1 text-indigo-700" for="estimated_shopee_profit">15. 預估蝦皮利潤 <span class="text-xs text-gray-500">(TWD)</span></label>
                                <input class="shadow appearance-none border rounded w-full py-1 px-2 text-sm leading-tight focus:outline-none focus:shadow-outline font-bold text-lg" id="estimated_shopee_profit" type="number" placeholder="自動計算" readonly>
                                <p class="text-xs text-gray-500 mt-1">公式: 優惠價(14) - 單品成本(11)</p>
                            </div>
                        </div>

                        <!-- 綠界區塊 (單品 - 編號 16-19) -->
                        <div class="border p-3 rounded bg-teal-50 border-teal-100">
                            <p class="text-xs font-bold text-teal-800 mb-2 text-center border-b border-teal-200 pb-1">單品 - 綠界價格與利潤</p>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-gray-600 text-xs mb-1" for="greenworld_price_orig">16. 原價</label>
                                    <input class="shadow appearance-none border rounded w-full py-1 px-2 text-sm" id="greenworld_price_orig" type="number">
                                </div>
                                <div>
                                    <label class="block text-gray-600 text-xs mb-1" for="greenworld_price_discount">17. 優惠價</label>
                                    <input class="shadow appearance-none border border-teal-400 rounded w-full py-1 px-2 text-sm font-bold" id="greenworld_price_discount" type="number" oninput="calculateEstimatedProfit()">
                                </div>
                            </div>
                            
                            <!-- 18. 預估綠界單品利潤 -->
                            <div class="pt-2 border-t border-teal-200 mt-3">
                                <label class="block text-gray-700 text-xs font-bold mb-1 text-teal-700" for="estimated_greenworld_profit">18. 預估綠界利潤 <span class="text-xs text-gray-500">(TWD)</span></label>
                                <input class="shadow appearance-none border rounded w-full py-1 px-2 text-sm leading-tight focus:outline-none focus:shadow-outline font-bold text-lg" id="estimated_greenworld_profit" type="number" placeholder="自動計算" readonly>
                                <p class="text-xs text-gray-500 mt-1">公式: 優惠價(17) - 單品成本(11)</p>
                            </div>
                        </div>
                    </div>

                    <!-- 第六區：套裝售價策略 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- 蝦皮套裝區塊 (編號 19-22) -->
                        <div class="border p-3 rounded bg-cyan-50 border-cyan-100">
                            <p class="text-xs font-bold text-cyan-800 mb-2 text-center border-b border-cyan-200 pb-1">套裝 - 蝦皮價格與利潤</p>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-gray-600 text-xs mb-1" for="shopee_bundle_price_orig">19. 套裝原價</label>
                                    <input class="shadow appearance-none border rounded w-full py-1 px-2 text-sm" id="shopee_bundle_price_orig" type="number">
                                </div>
                                <div>
                                    <label class="block text-gray-600 text-xs mb-1" for="shopee_bundle_price_discount">20. 套裝優惠價</label>
                                    <input class="shadow appearance-none border border-cyan-400 rounded w-full py-1 px-2 text-sm font-bold" id="shopee_bundle_price_discount" type="number" oninput="calculateEstimatedProfit()">
                                </div>
                            </div>

                            <!-- 21. 預估蝦皮套裝利潤 -->
                            <div class="pt-2 border-t border-cyan-200 mt-3">
                                <label class="block text-gray-700 text-xs font-bold mb-1 text-cyan-700" for="estimated_shopee_bundle_profit">21. 預估套裝利潤 <span class="text-xs text-gray-500">(TWD)</span></label>
                                <input class="shadow appearance-none border rounded w-full py-1 px-2 text-sm leading-tight focus:outline-none focus:shadow-outline font-bold text-lg" id="estimated_shopee_bundle_profit" type="number" placeholder="自動計算" readonly>
                                <p class="text-xs text-gray-500 mt-1">公式: 優惠價(20) - 套裝總成本(12)</p>
                            </div>
                        </div>

                        <!-- 綠界套裝區塊 (編號 22-25) -->
                        <div class="border p-3 rounded bg-purple-50 border-purple-100">
                            <p class="text-xs font-bold text-purple-800 mb-2 text-center border-b border-purple-200 pb-1">套裝 - 綠界價格與利潤</p>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-gray-600 text-xs mb-1" for="greenworld_bundle_price_orig">22. 套裝原價</label>
                                    <input class="shadow appearance-none border rounded w-full py-1 px-2 text-sm" id="greenworld_bundle_price_orig" type="number">
                                </div>
                                <div>
                                    <label class="block text-gray-600 text-xs mb-1" for="greenworld_bundle_price_discount">23. 套裝優惠價</label>
                                    <input class="shadow appearance-none border border-purple-400 rounded w-full py-1 px-2 text-sm font-bold" id="greenworld_bundle_price_discount" type="number" oninput="calculateEstimatedProfit()">
                                </div>
                            </div>
                            
                            <!-- 24. 預估綠界套裝利潤 -->
                            <div class="pt-2 border-t border-purple-200 mt-3">
                                <label class="block text-gray-700 text-xs font-bold mb-1 text-purple-700" for="estimated_greenworld_bundle_profit">24. 預估套裝利潤 <span class="text-xs text-gray-500">(TWD)</span></label>
                                <input class="shadow appearance-none border rounded w-full py-1 px-2 text-sm leading-tight focus:outline-none focus:shadow-outline font-bold text-lg" id="estimated_greenworld_bundle_profit" type="number" placeholder="自動計算" readonly>
                                <p class="text-xs text-gray-500 mt-1">公式: 優惠價(23) - 套裝總成本(12)</p>
                            </div>
                        </div>
                    </div>


                    <div class="mb-4">
                        <label class="block text-gray-700 text-xs font-bold mb-2" for="note">備註 / 細節</label>
                        <textarea class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="note" rows="2"></textarea>
                    </div>

                    <div class="flex items-center justify-end mt-4 pt-4 border-t">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded mr-2 focus:outline-none focus:shadow-outline">取消</button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">儲存產品資料</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (模組化載入) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // 全域變數
        window.db = null;
        window.storage = null;
        window.productsCollection = null;
        window.allProducts = []; 

        // 【更新】嵌入的 Firebase 設定檔
        const EMBEDDED_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAc_WnUBQz6nYqoUNZmMHBm62lKMITAxYA",
            authDomain: "ms-app-710ea.firebaseapp.com",
            projectId: "ms-app-710ea",
            storageBucket: "ms-app-710ea.firebasestorage.app",
            messagingSenderId: "718163218564",
            appId: "1:718163218564:web:ba38466e922ffd27aa32d1"
        };


        // 輔助功能：計算預估利潤 (同時計算單品和套裝)
        window.calculateEstimatedProfit = function() {
            // --- 單品計算 (以單品成本計算) ---
            const singleCostValue = Number(document.getElementById('cost_value').value) || 0;
            const shopeePriceDiscount = Number(document.getElementById('shopee_price_discount').value) || 0;
            const greenworldPriceDiscount = Number(document.getElementById('greenworld_price_discount').value) || 0;
            
            // 計算蝦皮單品利潤 (15)
            const estimatedShopeeProfit = shopeePriceDiscount - singleCostValue;
            // 計算綠界單品利潤 (18)
            const estimatedGreenworldProfit = greenworldPriceDiscount - singleCostValue;

            // 更新單品利潤欄位
            const shopeeProfitInput = document.getElementById('estimated_shopee_profit');
            shopeeProfitInput.value = estimatedShopeeProfit.toFixed(0); 
            const greenworldProfitInput = document.getElementById('estimated_greenworld_profit');
            greenworldProfitInput.value = estimatedGreenworldProfit.toFixed(0);
            
            // --- 套裝計算 (以套裝總成本計算) ---
            const bundleCostValue = Number(document.getElementById('bundle_cost_value').value) || 0;
            const shopeeBundleDiscount = Number(document.getElementById('shopee_bundle_price_discount').value) || 0;
            const greenworldBundleDiscount = Number(document.getElementById('greenworld_bundle_price_discount').value) || 0;

            // 計算蝦皮套裝利潤 (21)
            const estimatedShopeeBundleProfit = shopeeBundleDiscount - bundleCostValue;
            // 計算綠界套裝利潤 (24)
            const estimatedGreenworldBundleProfit = greenworldBundleDiscount - bundleCostValue;

            // 更新套裝利潤欄位
            const shopeeBundleProfitInput = document.getElementById('estimated_shopee_bundle_profit');
            shopeeBundleProfitInput.value = estimatedShopeeBundleProfit.toFixed(0);
            const greenworldBundleProfitInput = document.getElementById('estimated_greenworld_bundle_profit');
            greenworldBundleProfitInput.value = estimatedGreenworldBundleProfit.toFixed(0);

            // 根據利潤高低調整顏色
            function applyColor(inputElement, profit) {
                inputElement.classList.remove('text-red-700', 'bg-red-100', 'text-green-700', 'bg-green-100', 'text-gray-700', 'bg-white');
                if (profit > 0) {
                    inputElement.classList.add('text-green-700', 'bg-green-100');
                } else if (profit < 0) {
                    inputElement.classList.add('text-red-700', 'bg-red-100');
                } else {
                     inputElement.classList.add('text-gray-700', 'bg-white');
                }
            }

            applyColor(shopeeProfitInput, estimatedShopeeProfit);
            applyColor(greenworldProfitInput, estimatedGreenworldProfit);
            applyColor(shopeeBundleProfitInput, estimatedShopeeBundleProfit);
            applyColor(greenworldBundleProfitInput, estimatedGreenworldBundleProfit);
        };

        // 【更新】1. 檢查並載入設定：直接使用嵌入的設定
        window.onload = function() {
            // 由於設定已硬編碼，我們直接初始化 Firebase
            initFirebase(EMBEDDED_FIREBASE_CONFIG);
        };

        // 【移除】2. 儲存設定：此功能已不再需要

        // 3. 初始化 Firebase
        function initFirebase(config) {
            try {
                const app = initializeApp(config);
                const auth = getAuth(app);
                window.db = getFirestore(app);
                window.storage = getStorage(app); 
                window.productsCollection = collection(window.db, "products"); 

                signInAnonymously(auth).then(() => {
                    console.log("Logged in anonymously");
                    loadProducts();
                    // 確保 app 區塊可以顯示 (如果之前有被隱藏)
                    document.getElementById('app').classList.remove('hidden'); 
                }).catch((error) => {
                    console.error("Auth Error", error);
                    showTemporaryMessage("登入失敗，請檢查 Firebase 設定。", 'bg-red-500');
                });

            } catch (e) {
                console.error("Firebase 初始化失敗", e);
                showTemporaryMessage("Firebase 初始化失敗，請檢查嵌入的設定是否正確。", 'bg-red-500');
                // 即使設定是硬編碼，也清除舊的本地設定以防干擾
                localStorage.removeItem('my_style_firebase_config'); 
            }
        }

        // 4. 讀取產品 (Real-time)
        function loadProducts() {
            const spinner = document.getElementById('loading-spinner');
            const tbody = document.getElementById('product-table-body');
            spinner.classList.remove('hidden');
            
            const q = query(window.productsCollection, orderBy("sku", "asc")); 

            onSnapshot(q, (querySnapshot) => {
                window.allProducts = [];
                tbody.innerHTML = '';
                let count = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    data.id = doc.id; 
                    window.allProducts.push(data);
                    count++;
                });

                document.getElementById('total-count').innerText = count;
                renderTable(window.allProducts);
                spinner.classList.add('hidden');
            }, (error) => {
                console.error("Error getting documents: ", error);
                if(error.code === 'permission-denied') {
                    tbody.innerHTML = `<tr><td colspan="10" class="px-6 py-4 text-center text-red-500 text-sm">權限不足！請檢查您的 Firestore 安全規則是否允許讀取。</td></tr>`;
                } else {
                    tbody.innerHTML = `<tr><td colspan="10" class="px-6 py-4 text-center text-red-500 text-sm">載入資料時發生錯誤：${error.message}</td></tr>`;
                }
                spinner.classList.add('hidden');
            });
        }

        // 5. 渲染表格 (不變)
        window.renderTable = function(products) {
            const tbody = document.getElementById('product-table-body');
            tbody.innerHTML = '';

            if (products.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-gray-500">尚無產品資料</td></tr>`;
                return;
            }

            products.forEach(p => {
                const tr = document.createElement('tr');
                
                // 單品成本顯示
                const costDisplay = `${p.cost_currency || 'N/A'} ${p.cost_value || 0}`;
                // 蝦皮單品優惠價
                const shopeeDiscountPrice = p.shopee_price_discount || p.shopee_price_orig || 0;
                
                // 決定單品利潤的顏色
                const shopeeProfitColor = p.estimated_shopee_profit > 0 ? 'text-green-600 font-bold' : (p.estimated_shopee_profit < 0 ? 'text-red-600' : 'text-gray-500');
                const greenworldProfitColor = p.estimated_greenworld_profit > 0 ? 'text-green-600 font-bold' : (p.estimated_greenworld_profit < 0 ? 'text-red-600' : 'text-gray-500');

                // 決定套裝利潤的顏色
                const shopeeBundleProfitColor = p.estimated_shopee_bundle_profit > 0 ? 'text-green-600 font-bold' : (p.estimated_shopee_bundle_profit < 0 ? 'text-red-600' : 'text-gray-500');
                const greenworldBundleProfitColor = p.estimated_greenworld_bundle_profit > 0 ? 'text-green-600 font-bold' : (p.estimated_greenworld_bundle_profit < 0 ? 'text-red-600' : 'text-gray-500');
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex-shrink-0 h-16 w-16">
                            <img class="h-16 w-16 rounded object-cover" src="${p.image_url || 'https://via.placeholder.com/150?text=No+Image'}" alt="產品圖片" onerror="this.src='https://placehold.co/150x150/e0e7ff/6366f1?text=No+Img'">
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.sku || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate" title="${p.shopee_name_zh}">${p.shopee_name_zh || '未命名'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${costDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-indigo-600">NT$${shopeeDiscountPrice}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${shopeeProfitColor}">NT$${p.estimated_shopee_profit || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${greenworldProfitColor}">NT$${p.estimated_greenworld_profit || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${shopeeBundleProfitColor}">NT$${p.estimated_shopee_bundle_profit || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${greenworldBundleProfitColor}">NT$${p.estimated_greenworld_bundle_profit || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editProduct('${p.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3 p-1 rounded hover:bg-indigo-100 transition"><i class="fas fa-edit"></i></button>
                        <button onclick="confirmDeleteProduct('${p.id}')" class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-100 transition"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        };

        // 6. 搜尋過濾 (不變)
        window.filterProducts = function() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = window.allProducts.filter(p => 
                (p.sku && p.sku.toLowerCase().includes(term)) || 
                (p.shopee_name_zh && p.shopee_name_zh.toLowerCase().includes(term)) ||
                (p.vendor_product_name && p.vendor_product_name.toLowerCase().includes(term))
            );
            renderTable(filtered);
        };

        // 7. 處理表單提交 (不變)
        window.handleFormSubmit = async function(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerText;
            
            submitBtn.innerText = "處理中 (請稍候)...";
            submitBtn.disabled = true;

            const docId = document.getElementById('doc-id').value;
            const fileInput = document.getElementById('image_file');
            const existingImageUrl = document.getElementById('existing_image_url').value;
            let imageUrl = existingImageUrl;

            try {
                // 檢查是否有新的圖片要上傳
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const sku = document.getElementById('sku').value.trim() || `product-${Date.now()}`;
                    // 使用 SKU + 隨機數確保檔案名稱唯一
                    const storagePath = `product_images/${sku}_${Date.now()}_${file.name}`; 
                    
                    if (!window.storage) {
                         throw new Error("Firebase Storage 未初始化。請檢查您的設定。");
                    }
                    
                    const storageRef = ref(window.storage, storagePath);
                    
                    // 上傳檔案
                    submitBtn.innerText = "上傳圖片中...";
                    const snapshot = await uploadBytes(storageRef, file);
                    
                    // 取得下載 URL
                    imageUrl = await getDownloadURL(snapshot.ref);
                    showTemporaryMessage("圖片上傳成功！", 'bg-green-500');
                }
                
                // ** 在儲存前，執行利潤計算 **
                window.calculateEstimatedProfit();

                // 收集所有欄位的數據
                const productData = {
                    sku: document.getElementById('sku').value.trim(),
                    image_url: imageUrl, 
                    weight_g: Number(document.getElementById('weight_g').value) || 0,
                    made_in: document.getElementById('made_in').value.trim(),
                    vendor_new_date: document.getElementById('vendor_new_date').value,
                    
                    vendor_shop_name: document.getElementById('vendor_shop_name').value.trim(), 
                    vendor_product_name: document.getElementById('vendor_product_name').value.trim(), 
                    
                    shopee_name_zh: document.getElementById('shopee_name_zh').value.trim(),
                    listing_date: document.getElementById('listing_date').value,
                    cost_currency: document.getElementById('cost_currency').value,
                    
                    // 成本 (單品與套裝)
                    cost_value: Number(document.getElementById('cost_value').value) || 0, // 11. 單品成本價
                    bundle_cost_value: Number(document.getElementById('bundle_cost_value').value) || 0, // 12. 套裝總成本

                    // 單品價格與利潤
                    shopee_price_orig: Number(document.getElementById('shopee_price_orig').value) || 0, // 13. 蝦皮單品原價
                    shopee_price_discount: Number(document.getElementById('shopee_price_discount').value) || 0, // 14. 蝦皮單品優惠價
                    estimated_shopee_profit: Number(document.getElementById('estimated_shopee_profit').value) || 0, // 15. 蝦皮單品利潤
                    
                    greenworld_price_orig: Number(document.getElementById('greenworld_price_orig').value) || 0, // 16. 綠界單品原價
                    greenworld_price_discount: Number(document.getElementById('greenworld_price_discount').value) || 0, // 17. 綠界單品優惠價
                    estimated_greenworld_profit: Number(document.getElementById('estimated_greenworld_profit').value) || 0, // 18. 綠界單品利潤
                    
                    // 套裝價格與利潤
                    shopee_bundle_price_orig: Number(document.getElementById('shopee_bundle_price_orig').value) || 0, // 19. 蝦皮套裝原價
                    shopee_bundle_price_discount: Number(document.getElementById('shopee_bundle_price_discount').value) || 0, // 20. 蝦皮套裝優惠價
                    estimated_shopee_bundle_profit: Number(document.getElementById('estimated_shopee_bundle_profit').value) || 0, // 21. 蝦皮套裝利潤
                    
                    greenworld_bundle_price_orig: Number(document.getElementById('greenworld_bundle_price_orig').value) || 0, // 22. 綠界套裝原價
                    greenworld_bundle_price_discount: Number(document.getElementById('greenworld_bundle_price_discount').value) || 0, // 23. 綠界套裝優惠價
                    estimated_greenworld_bundle_profit: Number(document.getElementById('estimated_greenworld_bundle_profit').value) || 0, // 24. 綠界套裝利潤

                    note: document.getElementById('note').value.trim(),
                    updated_at: new Date().toISOString()
                };

                // 儲存 Firestore 資料
                submitBtn.innerText = "儲存資料庫中...";
                if (docId) {
                    await updateDoc(doc(window.db, "products", docId), productData);
                } else {
                    productData.created_at = new Date().toISOString();
                    await addDoc(window.productsCollection, productData);
                }
                
                showTemporaryMessage(docId ? "產品資料已更新成功！" : "新產品已新增成功！", 'bg-indigo-500');
                closeModal();
            } catch (error) {
                console.error("儲存失敗: ", error);
                showTemporaryMessage(`儲存產品資料失敗！錯誤: ${error.message}. 請檢查 Firebase Storage 規則是否允許寫入。`, 'bg-red-500');
            } finally {
                submitBtn.innerText = originalText;
                submitBtn.disabled = false;
            }
        };

        // 8. 刪除確認 (不變)
        window.confirmDeleteProduct = function(id) {
            // 使用瀏覽器內建的 confirm，因為這是 Canvas 運行環境推薦的方式
            if (confirm("確定要刪除這個產品嗎？此操作不可逆！")) {
                 deleteProduct(id);
            }
        }

        // 9. 刪除 (不變)
        async function deleteProduct(id) {
            try {
                await deleteDoc(doc(window.db, "products", id));
                showTemporaryMessage("產品已成功刪除。", 'bg-red-500');
            } catch (error) {
                console.error("刪除失敗: ", error.message);
                showTemporaryMessage("刪除產品失敗！", 'bg-red-500');
            }
        };
        
        // 圖片預覽功能 (不變)
        window.previewImage = function(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('image-preview');
            const previewContainer = document.getElementById('image-preview-container');
            const currentName = document.getElementById('current-image-name');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    previewContainer.classList.remove('hidden');
                    currentName.innerText = `將上傳新圖: ${file.name}`;
                };
                reader.readAsDataURL(file);
            } else {
                const existingUrl = document.getElementById('existing_image_url').value;
                if(existingUrl) {
                    preview.src = existingUrl;
                    previewContainer.classList.remove('hidden');
                    currentName.innerText = "保留原圖";
                } else {
                    previewContainer.classList.add('hidden');
                }
            }
        }

        // 10. 編輯/開啟模態視窗 (不變)
        window.editProduct = function(id) {
            const p = window.allProducts.find(item => item.id === id);
            if (!p) return;

            document.getElementById('doc-id').value = id;
            document.getElementById('modal-title').innerText = "編輯產品 (SKU: " + (p.sku || 'N/A') + ")";
            
            // 重置檔案選擇框
            document.getElementById('image_file').value = null; 
            
            // 儲存已存在的 URL 並處理預覽
            document.getElementById('existing_image_url').value = p.image_url || '';
            const previewContainer = document.getElementById('image-preview-container');
            const preview = document.getElementById('image-preview');
            const currentName = document.getElementById('current-image-name');
            
            if (p.image_url) {
                preview.src = p.image_url;
                currentName.innerText = "目前圖片已存在 (可重新選擇上傳)";
                previewContainer.classList.remove('hidden');
            } else {
                previewContainer.classList.add('hidden');
            }

            // 填入所有欄位
            document.getElementById('sku').value = p.sku || '';
            document.getElementById('weight_g').value = p.weight_g || 0;
            document.getElementById('made_in').value = p.made_in || '';
            document.getElementById('vendor_new_date').value = p.vendor_new_date || '';
            document.getElementById('vendor_shop_name').value = p.vendor_shop_name || ''; 
            document.getElementById('vendor_product_name').value = p.vendor_product_name || p.vendor_name || ''; 
            document.getElementById('shopee_name_zh').value = p.shopee_name_zh || '';
            document.getElementById('listing_date').value = p.listing_date || '';
            document.getElementById('cost_currency').value = p.cost_currency || 'KRW';
            
            // 成本
            document.getElementById('cost_value').value = p.cost_value || 0; // 單品成本
            document.getElementById('bundle_cost_value').value = p.bundle_cost_value || 0; // 套裝總成本
            
            // 單品
            document.getElementById('shopee_price_orig').value = p.shopee_price_orig || 0;
            document.getElementById('shopee_price_discount').value = p.shopee_price_discount || 0;
            document.getElementById('estimated_shopee_profit').value = p.estimated_shopee_profit || 0; 
            
            document.getElementById('greenworld_price_orig').value = p.greenworld_price_orig || 0;
            document.getElementById('greenworld_price_discount').value = p.greenworld_price_discount || 0;
            document.getElementById('estimated_greenworld_profit').value = p.estimated_greenworld_profit || 0; 
            
            // 套裝 (新欄位)
            document.getElementById('shopee_bundle_price_orig').value = p.shopee_bundle_price_orig || 0;
            document.getElementById('shopee_bundle_price_discount').value = p.shopee_bundle_price_discount || 0;
            document.getElementById('estimated_shopee_bundle_profit').value = p.estimated_shopee_bundle_profit || 0;

            document.getElementById('greenworld_bundle_price_orig').value = p.greenworld_bundle_price_orig || 0;
            document.getElementById('greenworld_bundle_price_discount').value = p.greenworld_bundle_price_discount || 0;
            document.getElementById('estimated_greenworld_bundle_profit').value = p.estimated_greenworld_bundle_profit || 0;
            
            document.getElementById('note').value = p.note || '';

            // 載入資料後，進行一次計算，確保利潤顯示正確
            window.calculateEstimatedProfit();

            document.getElementById('product-modal').classList.remove('hidden');
        };

        // 11. 匯出 Excel (更新欄位名稱) (不變)
        window.exportToExcel = function() {
            if (window.allProducts.length === 0) {
                showTemporaryMessage("沒有資料可以匯出！", 'bg-yellow-500');
                return;
            }
            
            const data = window.allProducts.map(p => ({
                "1. 上架商品號": p.sku || '',
                "2. 產品圖": p.image_url || '',
                "3. 預估重量": p.weight_g || 0,
                "4. Made in": p.made_in || '',
                "5. 檔口上新日期": p.vendor_new_date || '',
                "6. 檔口": p.vendor_shop_name || '', 
                "7. 商品名稱(檔口品名)": p.vendor_product_name || p.vendor_name || '', 
                "8. 蝦皮中文品名": p.shopee_name_zh || '',
                "9. 上架日期": p.listing_date || '',
                "10. 幣別": p.cost_currency || 'KRW',
                "11. 單品成本價(TWD)": p.cost_value || 0,
                "12. 套裝總成本(TWD)": p.bundle_cost_value || 0,
                
                "13. 單品蝦皮原價": p.shopee_price_orig || 0,
                "14. 單品蝦皮優惠價": p.shopee_price_discount || 0,
                "15. 單品蝦皮利潤": p.estimated_shopee_profit || 0, 
                
                "16. 單品綠界原價": p.greenworld_price_orig || 0,
                "17. 單品綠界優惠價": p.greenworld_price_discount || 0,
                "18. 單品綠界利潤": p.estimated_greenworld_profit || 0, 
                
                "19. 套裝蝦皮原價": p.shopee_bundle_price_orig || 0,
                "20. 套裝蝦皮優惠價": p.shopee_bundle_price_discount || 0,
                "21. 套裝蝦皮利潤": p.estimated_shopee_bundle_profit || 0,
                
                "22. 套裝綠界原價": p.greenworld_bundle_price_orig || 0,
                "23. 套裝綠界優惠價": p.greenworld_bundle_price_discount || 0,
                "24. 套裝綠界利潤": p.estimated_greenworld_bundle_profit || 0
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "MyStyle_Products");

            const date = new Date().toISOString().slice(0,10).replace(/-/g, '');
            XLSX.writeFile(wb, `MyStyle_Products_Backup_${date}.xlsx`);
            
            console.log("匯出完成");
            showTemporaryMessage("產品資料已成功匯出為 Excel 檔案！", 'bg-green-500');
        };

        // UI 輔助功能 (不變)
        window.openModal = function(type) {
            if (type === 'add') {
                document.getElementById('product-form').reset();
                document.getElementById('doc-id').value = '';
                document.getElementById('existing_image_url').value = ''; 
                document.getElementById('modal-title').innerText = "新增產品";
                document.getElementById('cost_currency').value = 'KRW';
                document.getElementById('image-preview-container').classList.add('hidden'); 

                // 初始化利潤欄位並清除顏色
                document.getElementById('estimated_shopee_profit').value = 0; 
                document.getElementById('estimated_greenworld_profit').value = 0; 
                document.getElementById('estimated_shopee_bundle_profit').value = 0; 
                document.getElementById('estimated_greenworld_bundle_profit').value = 0; 

                // 清除所有利潤欄位的顏色標記
                const profitInputs = [
                    'estimated_shopee_profit', 'estimated_greenworld_profit', 
                    'estimated_shopee_bundle_profit', 'estimated_greenworld_bundle_profit'
                ];
                profitInputs.forEach(id => {
                    const input = document.getElementById(id);
                    input.classList.remove('text-red-700', 'bg-red-100', 'text-green-700', 'bg-green-100');
                    input.classList.add('text-gray-700', 'bg-white');
                });
            }
            // 開啟視窗時，進行一次計算以確保初始值正確
            window.calculateEstimatedProfit();

            document.getElementById('product-modal').classList.remove('hidden');
        };

        window.closeModal = function() {
            document.getElementById('product-modal').classList.add('hidden');
        };

        // 【更新】重置設定
        window.clearLocalConfig = function() {
            if(confirm("確定要重置設定嗎？目前的 Firebase 設定已嵌入程式碼中，重置只會清除瀏覽器中的歷史設定並重新載入，以便使用新的程式碼版本。")) { 
                // 雖然現在是硬編碼，但清除本地儲存是為了防止舊的設定干擾。
                localStorage.removeItem('my_style_firebase_config'); 
                location.reload();
            }
        };

        // 臨時訊息提示（取代 Alert） (不變)
        function showTemporaryMessage(message, bgColor) {
            let tempDiv = document.getElementById('temp-message');
            if (!tempDiv) {
                tempDiv = document.createElement('div');
                tempDiv.id = 'temp-message';
                tempDiv.className = 'fixed bottom-5 right-5 z-50 p-4 rounded-lg shadow-xl text-white font-bold transition-opacity duration-300 opacity-0';
                document.body.appendChild(tempDiv);
            }
            
            tempDiv.className = `fixed bottom-5 right-5 z-50 p-4 rounded-lg shadow-xl text-white font-bold ${bgColor} opacity-100`;
            tempDiv.innerText = message;

            setTimeout(() => {
                tempDiv.classList.remove('opacity-100');
                tempDiv.classList.add('opacity-0');
            }, 3000); // 顯示 3 秒
        }
    </script>
</body>
</html>