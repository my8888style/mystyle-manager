import React, { useState, useEffect, useMemo } from 'react';
import { 
  Plus, Search, Package, Calculator, History, Download, 
  Trash2, Edit2, ChevronDown, CheckCircle, Info, Settings,
  X, Save, ArrowDownCircle, ArrowUpCircle
} from 'lucide-react';

const App = () => {
  // --- State ---
  const [view, setView] = useState('inventory');
  const [gender, setGender] = useState('male');
  const [calcMode, setCalcMode] = useState('korea');
  const [selectedLogisticsId, setSelectedLogisticsId] = useState(0);

  // --- Inventory Records State ---
  const [records, setRecords] = useState([
    { id: 1, sku: 'SKU12345', type: 'IN', qty: 15, date: '2023-10-27 14:30', note: '首批進貨' },
    { id: 2, sku: 'SKU99887', type: 'OUT', qty: 2, date: '2023-10-28 10:15', note: '蝦皮訂單 #A1' }
  ]);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [currentRecord, setCurrentRecord] = useState(null);

  // --- Calculator Inputs ---
  const [calcInputs, setCalcInputs] = useState({
    tPrice: 0,
    tRate: 5,
    tQty: 1,
    tWeight: 0.5,
    tHonor: false,
    tTaxIncl: false,
    tCat: 40,
    kPrice: 0,
    kRate: 40,
    kQty: 1,
    kWeight: 0.5,
    kCat: 40,
    customMargin: 50
  });

  const handleInputChange = (e) => {
    const { id, value, type, checked } = e.target;
    setCalcInputs(prev => ({
      ...prev,
      [id]: type === 'checkbox' ? checked : parseFloat(value) || 0
    }));
  };

  // --- Calculation Logic ---
  const logisticsResults = useMemo(() => {
    const { 
      tPrice, tRate, tQty, tWeight, tHonor, tTaxIncl, tCat,
      kPrice, kRate, kQty, kWeight, kCat
    } = calcInputs;
    
    let results = [];
    const pkg = 15;

    if (calcMode === 'taobao') {
      const amtTwd = tPrice * tRate;
      const fee3 = amtTwd * tQty * 0.03;
      const cardFee = amtTwd * 0.015;
      const honorFee = tHonor ? amtTwd * 0.05 : 0;
      const taxFee = tTaxIncl ? (tCat * tWeight) : 0;
      const totalCost = amtTwd + (fee3 / tQty) + cardFee + honorFee + taxFee + pkg;

      results.push({
        id: 0,
        name: "淘寶集運",
        cost: Math.round(totalCost),
        formula: `(CNY:${tPrice}*匯率:${tRate}=${amtTwd}) + (手續3%:${Math.round(fee3/tQty)}) + (刷卡1.5%:${Math.round(cardFee)}) + (尊榮5%:${Math.round(honorFee)}) + (關稅:${Math.round(taxFee)}) + (包材:15)`
      });
    } else {
      const koreaLogistics = [
        { id: 1, name: "EASYBOX-含稅-空運(10kg)", fee: 7800, agent: 0.03, tax: false },
        { id: 2, name: "EASYBOX-未稅-空運(10kg)", fee: 5900, agent: 0.03, tax: true },
        { id: 3, name: "EASYBOX-未稅-海運(10kg)", fee: 3900, agent: 0.03, tax: true },
        { id: 4, name: "SL-含稅-直飛(10kg)", fee: 6100, agent: 0.03, tax: false },
        { id: 5, name: "SL-含稅-轉機(10kg)", fee: 5100, agent: 0.03, tax: false },
        { id: 6, name: "SL-未稅-轉機(5kg)", fee: 3500, agent: 0.03, tax: true },
        { id: 7, name: "SL-未稅-直飛(5kg)", fee: 4500, agent: 0.03, tax: true },
        { id: 8, name: "TN-含稅-空運(10kg)", fee: 6500, agent: 0.03, tax: false },
        { id: 9, name: "TN-含稅-空運(10kg-平台)", fee: 6500, agent: 0.05, tax: false },
        { id: 10, name: "TN-未稅-空運(5kg)", fee: 5000, agent: 0.03, tax: true },
        { id: 11, name: "九泰-未稅-空運(1kg)", fee: 3800, agent: 0.03, tax: true },
        { id: 12, name: "SS-未稅-空運(5kg)", fee: 5000, agent: 0.03, tax: true },
        { id: 13, name: "Haru-未稅-空運(3kg)", fee: 3900, agent: 0.03, tax: true }
      ];

      results = koreaLogistics.map(l => {
        const shipping = l.fee * kWeight;
        const agent = kPrice * l.agent;
        const krTwd = ((kPrice * kWeight) + shipping + agent) / kRate;
        const tax = l.tax ? (kCat * kWeight) : 0;
        const total = krTwd + tax + pkg;
        return {
          id: l.id,
          name: l.name,
          cost: Math.round(total),
          formula: `((採購${kPrice}*重${kWeight}=${kPrice*kWeight}) + 運費${shipping} + 代購${Math.round(agent)}) / 匯率${kRate} + 稅${Math.round(tax)} + 15`
        };
      });
    }
    return results;
  }, [calcInputs, calcMode]);

  const currentCost = useMemo(() => {
    const selected = logisticsResults.find(r => r.id === selectedLogisticsId);
    return selected ? selected.cost : (logisticsResults[0]?.cost || 0);
  }, [logisticsResults, selectedLogisticsId]);

  const margin = (1 + (calcInputs.customMargin / 100));
  const hopePrice = Math.round(currentCost * margin);

  // --- Record Functions ---
  const handleAddRecord = () => {
    setCurrentRecord({ id: Date.now(), sku: '', type: 'IN', qty: 1, date: new Date().toLocaleString(), note: '' });
    setIsModalOpen(true);
  };

  const handleEditRecord = (record) => {
    setCurrentRecord({ ...record });
    setIsModalOpen(true);
  };

  const handleDeleteRecord = (id) => {
    setRecords(records.filter(r => r.id !== id));
  };

  const handleSaveRecord = () => {
    if (!currentRecord.sku) return;
    if (records.find(r => r.id === currentRecord.id)) {
      setRecords(records.map(r => r.id === currentRecord.id ? currentRecord : r));
    } else {
      setRecords([currentRecord, ...records]);
    }
    setIsModalOpen(false);
  };

  return (
    <div className="min-h-screen bg-[#f3e9dc] p-4 md:p-8 text-slate-800">
      {/* Navigation */}
      <nav className="max-w-7xl mx-auto mb-8 flex flex-wrap justify-between items-center gap-6">
        <div className="flex items-center gap-3">
          <div className="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-md text-2xl font-bold text-gray-800">M</div>
          <h1 className="text-3xl font-bold tracking-tight">MS 服飾管理系統</h1>
        </div>
        <div className="flex gap-2 flex-wrap">
          <button onClick={() => setView('inventory')} className={`px-5 py-2.5 rounded-full transition ${view === 'inventory' ? 'bg-white shadow-md font-bold' : 'hover:bg-white/50'}`}>商品庫存</button>
          <button onClick={() => setView('calculator')} className={`px-5 py-2.5 rounded-full transition ${view === 'calculator' ? 'bg-white shadow-md font-bold' : 'hover:bg-white/50'}`}>價格計算</button>
          <button onClick={() => setView('history')} className={`px-5 py-2.5 rounded-full transition ${view === 'history' ? 'bg-white shadow-md font-bold' : 'hover:bg-white/50'}`}>進出貨紀錄</button>
        </div>
      </nav>

      <main className="max-w-7xl mx-auto space-y-8">
        
        {view === 'inventory' && (
          <section className="bg-white/80 backdrop-blur-md rounded-[32px] p-8 shadow-xl border border-white">
             <div className="flex justify-between items-center mb-8">
                <h2 className="text-2xl font-bold">📦 商品庫存清單</h2>
                <button className="bg-black text-white px-6 py-3 rounded-full flex items-center gap-2 hover:bg-zinc-800 transition">
                  <Plus size={20} /> 新增商品
                </button>
             </div>
             <div className="flex gap-4 mb-6">
                <div className="flex-1 relative">
                  <Search className="absolute left-4 top-3.5 text-gray-400" size={18} />
                  <input type="text" placeholder="搜尋 SKU 或品名..." className="w-full pl-12 pr-4 py-3 rounded-2xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-slate-300" />
                </div>
                <select className="px-4 py-3 rounded-2xl border border-gray-200">
                  <option>全部性別</option>
                  <option>男裝 (MY_STYLE)</option>
                  <option>女裝 (My_Select)</option>
                </select>
             </div>
             <div className="text-center py-20 text-gray-400">尚未建立商品資料</div>
          </section>
        )}

        {view === 'calculator' && (
          <section className="bg-white/80 backdrop-blur-md rounded-[32px] p-8 shadow-xl border border-white space-y-8">
            <div className={`p-6 rounded-3xl text-white shadow-lg transition-all ${gender === 'male' ? 'bg-[#8e9aaf]' : 'bg-[#cbc0d3]'}`}>
              <div className="flex justify-between items-center">
                <div>
                  <h2 className="text-3xl font-bold">精準利潤計算機</h2>
                  <p className="opacity-80 mt-1">請輸入採購數據，並選擇下方物流方案作為計算基準</p>
                </div>
                <div className="bg-white/20 p-1 rounded-full flex gap-1">
                  <button onClick={() => setGender('male')} className={`px-6 py-2 rounded-full transition ${gender === 'male' ? 'bg-white text-[#8e9aaf] font-bold' : 'text-white'}`}>男裝</button>
                  <button onClick={() => setGender('female')} className={`px-6 py-2 rounded-full transition ${gender === 'female' ? 'bg-white text-[#cbc0d3] font-bold' : 'text-white'}`}>女裝</button>
                </div>
              </div>
            </div>

            <div className="flex gap-4 border-b pb-4">
              <button onClick={() => {setCalcMode('taobao'); setSelectedLogisticsId(0);}} className={`px-6 py-2 rounded-lg font-bold ${calcMode === 'taobao' ? 'bg-orange-100 text-orange-700' : 'text-gray-400'}`}>淘寶計算</button>
              <button onClick={() => {setCalcMode('korea'); setSelectedLogisticsId(1);}} className={`px-6 py-2 rounded-lg font-bold ${calcMode === 'korea' ? 'bg-emerald-100 text-emerald-700' : 'text-gray-400'}`}>韓國計算</button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
              {calcMode === 'taobao' ? (
                <>
                  <div className="space-y-1"><label className="text-sm font-bold ml-1">採購價 (CNY)</label><input id="tPrice" type="number" value={calcInputs.tPrice} onChange={handleInputChange} className="w-full px-4 py-3 rounded-xl border border-gray-200" /></div>
                  <div className="space-y-1"><label className="text-sm font-bold ml-1">匯率</label><input id="tRate" type="number" value={calcInputs.tRate} onChange={handleInputChange} className="w-full px-4 py-3 rounded-xl border border-gray-200" /></div>
                  <div className="space-y-1"><label className="text-sm font-bold ml-1">商品數量</label><input id="tQty" type="number" value={calcInputs.tQty} onChange={handleInputChange} className="w-full px-4 py-3 rounded-xl border border-gray-200" /></div>
                  <div className="space-y-1"><label className="text-sm font-bold ml-1">預估重量 (KG)</label><input id="tWeight" type="number" value={calcInputs.tWeight} onChange={handleInputChange} className="w-full px-4 py-3 rounded-xl border border-gray-200" /></div>
                  <div className="col-span-1 flex items-center gap-2 pt-4"><input id="tHonor" type="checkbox" checked={calcInputs.tHonor} onChange={handleInputChange} className="w-5 h-5" /> <label className="font-medium">尊榮服務 (5%)</label></div>
                  <div className="col-span-1 flex items-center gap-2 pt-4"><input id="tTaxIncl" type="checkbox" checked={calcInputs.tTaxIncl} onChange={handleInputChange} className="w-5 h-5" /> <label className="font-medium">計算關稅</label></div>
                  <div className="space-y-1"><label className="text-sm font-bold ml-1">類別關稅</label><select id="tCat" value={calcInputs.tCat} onChange={handleInputChange} className="w-full px-4 py-3 rounded-xl border border-gray-200">
                    <option value="40">服飾 (40/kg)</option><option value="45">生活用品 (45/kg)</option><option value="50">美妝 (50/kg)</option><option value="60">食品玩具 (60/kg)</option>
                  </select></div>
                </>
              ) : (
                <>
                  <div className="space-y-1"><label className="text-sm font-bold ml-1">採購價 (KRW)</label><input id="kPrice" type="number" value={calcInputs.kPrice} onChange={handleInputChange} className="w-full px-4 py-3 rounded-xl border border-gray-200" /></div>
                  <div className="space-y-1"><label className="text-sm font-bold ml-1">匯率 (韓幣/台幣)</label><input id="kRate" type="number" value={calcInputs.kRate} onChange={handleInputChange} className="w-full px-4 py-3 rounded-xl border border-gray-200" /></div>
                  <div className="space-y-1"><label className="text-sm font-bold ml-1">商品預估重量 (KG)</label><input id="kWeight" type="number" value={calcInputs.kWeight} onChange={handleInputChange} className="w-full px-4 py-3 rounded-xl border border-gray-200" /></div>
                  <div className="space-y-1"><label className="text-sm font-bold ml-1">商品類別</label><select id="kCat" value={calcInputs.kCat} onChange={handleInputChange} className="w-full px-4 py-3 rounded-xl border border-gray-200">
                    <option value="40">服飾 (40/kg)</option><option value="45">生活用品 (45/kg)</option><option value="50">美妝 (50/kg)</option><option value="60">食品玩具 (60/kg)</option>
                  </select></div>
                </>
              )}
              <div className="space-y-1"><label className="text-sm font-bold ml-1 text-orange-600">希望毛利率 %</label><input id="customMargin" type="number" value={calcInputs.customMargin} onChange={handleInputChange} className="w-full px-4 py-3 rounded-xl border border-orange-200 bg-orange-50/30" /></div>
            </div>

            <div className="space-y-4">
              <h3 className="font-bold flex items-center gap-2 text-lg"><Package size={20}/> 點擊下方卡片選擇物流基準：</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {logisticsResults.map(res => (
                  <button 
                    key={res.id}
                    onClick={() => setSelectedLogisticsId(res.id)}
                    className={`text-left p-5 rounded-3xl border-2 transition-all group relative overflow-hidden ${selectedLogisticsId === res.id ? 'border-indigo-500 bg-indigo-50/50 ring-4 ring-indigo-100' : 'border-gray-100 bg-white hover:border-indigo-200'}`}
                  >
                    {selectedLogisticsId === res.id && <CheckCircle className="absolute right-4 top-4 text-indigo-500" size={20}/>}
                    <div className="text-xs font-bold text-gray-400 mb-1 uppercase tracking-tighter">{calcMode === 'taobao' ? 'TAOBAO' : 'KOREA LOGISTICS'}</div>
                    <div className="font-bold text-gray-800 text-lg">{res.name}</div>
                    <div className="text-2xl font-black text-indigo-700 mt-2">$ {res.cost}</div>
                    <div className="mt-3 text-[10px] font-mono text-gray-400 bg-white p-2 rounded-xl group-hover:text-gray-600 transition truncate">
                      {res.formula}
                    </div>
                  </button>
                ))}
              </div>
            </div>

            <div className="pt-8 border-t-2 border-dashed border-gray-200">
               <div className="flex items-center gap-3 mb-6">
                  <div className="w-2 h-8 bg-indigo-500 rounded-full"></div>
                  <h3 className="text-2xl font-bold italic">PROFIT ESTIMATE</h3>
               </div>
               <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-white">
                  <div className="p-8 rounded-[40px] bg-gradient-to-br from-orange-400 to-orange-500 shadow-xl">
                    <div className="flex justify-between items-start mb-6"><span className="font-bold text-sm bg-white/20 px-3 py-1 rounded-full text-white">蝦皮 (非檔期)</span></div>
                    <div className="text-4xl font-black mb-1">$ {hopePrice}</div>
                    <div className="text-xs opacity-80 mb-6">建議售價</div>
                    <div className="space-y-3 pt-6 border-t border-white/20">
                      <div className="flex justify-between text-lg font-black pt-2">
                        <span>預估利潤</span>
                        <span>$ {Math.round(hopePrice - (hopePrice * 0.115) - 60 - currentCost)}</span>
                      </div>
                    </div>
                  </div>
                  <div className="p-8 rounded-[40px] bg-gradient-to-br from-rose-500 to-red-600 shadow-xl">
                    <div className="flex justify-between items-start mb-6"><span className="font-bold text-sm bg-white/20 px-3 py-1 rounded-full text-white">蝦皮 (大促檔期)</span></div>
                    <div className="text-4xl font-black mb-1">$ {hopePrice}</div>
                    <div className="text-xs opacity-80 mb-6">建議售價</div>
                    <div className="space-y-3 pt-6 border-t border-white/20">
                      <div className="flex justify-between text-lg font-black pt-2">
                        <span>預估利潤</span>
                        <span>$ {Math.round(hopePrice - (hopePrice * 0.135) - 60 - currentCost)}</span>
                      </div>
                    </div>
                  </div>
                  <div className="p-8 rounded-[40px] bg-gradient-to-br from-emerald-500 to-teal-600 shadow-xl">
                    <div className="flex justify-between items-start mb-6"><span className="font-bold text-sm bg-white/20 px-3 py-1 rounded-full text-white">綠界 (M.S 系列)</span></div>
                    <div className="text-4xl font-black mb-1">$ {hopePrice}</div>
                    <div className="text-xs opacity-80 mb-6">建議售價</div>
                    <div className="space-y-3 pt-6 border-t border-white/20">
                      <div className="flex justify-between text-lg font-black pt-2">
                        <span>預估利潤</span>
                        <span>$ {Math.round(hopePrice - (hopePrice * 0.03) - 90 - currentCost)}</span>
                      </div>
                    </div>
                  </div>
               </div>
            </div>
          </section>
        )}

        {view === 'history' && (
          <section className="bg-white/80 backdrop-blur-md rounded-[32px] p-8 shadow-xl border border-white">
            <div className="flex justify-between items-center mb-8">
              <h2 className="text-2xl font-bold italic">TIMELINE - 進出貨紀錄管理</h2>
              <button 
                onClick={handleAddRecord}
                className="bg-black text-white px-6 py-3 rounded-full flex items-center gap-2 hover:bg-zinc-800 transition shadow-lg"
              >
                <Plus size={20} /> 新增紀錄
              </button>
            </div>
            
            <div className="space-y-4">
              {records.length > 0 ? records.map(record => (
                <div key={record.id} className="group p-6 bg-white rounded-3xl border border-gray-100 flex justify-between items-center shadow-sm hover:shadow-md transition-all">
                  <div className="flex items-center gap-4">
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold ${record.type === 'IN' ? 'bg-green-100 text-green-600' : 'bg-rose-100 text-rose-600'}`}>
                      {record.type === 'IN' ? <ArrowDownCircle /> : <ArrowUpCircle />}
                    </div>
                    <div>
                      <div className="flex items-center gap-2">
                        <span className="font-bold text-lg">{record.sku}</span>
                        <span className={`text-xs px-2 py-0.5 rounded-full font-bold ${record.type === 'IN' ? 'bg-green-100 text-green-600' : 'bg-rose-100 text-rose-600'}`}>{record.type === 'IN' ? '進貨' : '出貨'}</span>
                      </div>
                      <div className="text-xs text-gray-400 mt-1 flex gap-3">
                        <span>{record.date}</span>
                        {record.note && <span className="text-gray-500 italic">• {record.note}</span>}
                      </div>
                    </div>
                  </div>
                  <div className="flex items-center gap-6">
                    <div className={`text-2xl font-black ${record.type === 'IN' ? 'text-green-600' : 'text-rose-600'}`}>
                      {record.type === 'IN' ? '+' : '-'} {record.qty} <span className="text-sm">PCS</span>
                    </div>
                    <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                      <button onClick={() => handleEditRecord(record)} className="p-2 hover:bg-gray-100 rounded-full text-blue-600"><Edit2 size={18}/></button>
                      <button onClick={() => handleDeleteRecord(record.id)} className="p-2 hover:bg-gray-100 rounded-full text-rose-600"><Trash2 size={18}/></button>
                    </div>
                  </div>
                </div>
              )) : (
                <div className="text-center py-20 text-gray-400">尚無進出貨紀錄</div>
              )}
            </div>
          </section>
        )}
      </main>

      {/* Modal for Add/Edit Record */}
      {isModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm">
          <div className="bg-white rounded-[32px] w-full max-w-md p-8 shadow-2xl space-y-6">
            <div className="flex justify-between items-center">
              <h3 className="text-2xl font-bold">{records.find(r => r.id === currentRecord?.id) ? '修改紀錄' : '新增紀錄'}</h3>
              <button onClick={() => setIsModalOpen(false)} className="p-2 hover:bg-gray-100 rounded-full"><X/></button>
            </div>
            
            <div className="space-y-4">
              <div className="space-y-1">
                <label className="text-sm font-bold">SKU 代碼</label>
                <input 
                  type="text" 
                  value={currentRecord?.sku} 
                  onChange={(e) => setCurrentRecord({...currentRecord, sku: e.target.value})}
                  className="w-full px-4 py-3 rounded-xl border border-gray-200" 
                  placeholder="請輸入 SKU..."
                />
              </div>
              <div className="flex gap-4">
                <div className="flex-1 space-y-1">
                  <label className="text-sm font-bold">類型</label>
                  <select 
                    value={currentRecord?.type} 
                    onChange={(e) => setCurrentRecord({...currentRecord, type: e.target.value})}
                    className="w-full px-4 py-3 rounded-xl border border-gray-200"
                  >
                    <option value="IN">進貨 (+)</option>
                    <option value="OUT">出貨 (-)</option>
                  </select>
                </div>
                <div className="flex-1 space-y-1">
                  <label className="text-sm font-bold">數量</label>
                  <input 
                    type="number" 
                    value={currentRecord?.qty} 
                    onChange={(e) => setCurrentRecord({...currentRecord, qty: parseInt(e.target.value) || 0})}
                    className="w-full px-4 py-3 rounded-xl border border-gray-200" 
                  />
                </div>
              </div>
              <div className="space-y-1">
                <label className="text-sm font-bold">備註</label>
                <textarea 
                  value={currentRecord?.note} 
                  onChange={(e) => setCurrentRecord({...currentRecord, note: e.target.value})}
                  className="w-full px-4 py-3 rounded-xl border border-gray-200 h-24 resize-none" 
                  placeholder="備註資訊..."
                />
              </div>
            </div>

            <div className="flex gap-3 pt-4">
              <button onClick={() => setIsModalOpen(false)} className="flex-1 py-3 rounded-full border border-gray-200 font-bold">取消</button>
              <button 
                onClick={handleSaveRecord}
                className="flex-1 py-3 rounded-full bg-black text-white font-bold flex items-center justify-center gap-2 hover:bg-zinc-800"
              >
                <Save size={18}/> 儲存紀錄
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;