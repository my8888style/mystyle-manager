<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY_STYLE 產品管理系統 - 視覺優化版</title>
    <!-- Tailwind CSS (樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome (圖示) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SheetJS (Excel 匯出工具) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        /* 1. 奶茶色背景 */
        body { 
            /* 淺奶茶色 */
            background-color: #f7f3f0; 
            font-family: 'Inter', sans-serif; 
            color: #4a4a4a; /* 深色文字 */
        }
        /* 2. 標題大波浪圓體 (使用思源黑體TC或Noto Sans TC模擬圓體效果) */
        .title-font {
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
            /* 雖然沒有真正的「大波浪圓體」，但我們可以增加字重讓標題更突出 */
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @-webkit-keyframes spinner { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* 隱藏數字輸入框的上下箭頭 (Spinner) */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- 主介面 -->
    <div id="app" class="min-h-screen flex flex-col hidden">
        <!-- 導航列 -->
        <nav class="bg-white shadow-md border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <i class="fas fa-tshirt text-amber-600 text-2xl mr-3"></i>
                        <!-- 應用新的標題樣式 -->
                        <span class="title-font text-xl tracking-tight text-gray-900">MY_STYLE 產品管理系統</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="clearLocalConfig()" class="text-gray-400 hover:text-red-500 text-sm transition duration-150">重置設定</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- 統計與操作區 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white overflow-hidden shadow-lg rounded-xl p-5 border-l-4 border-amber-500 hover:shadow-xl transition duration-300">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-amber-100 rounded-md p-3">
                            <i class="fas fa-box text-amber-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">目前產品總數</dt>
                                <dd class="flex items-baseline">
                                    <div id="total-count" class="text-2xl font-bold text-gray-900">0</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow-lg rounded-xl p-5 border-l-4 border-green-500">
                    <button onclick="openModal('add')" class="w-full h-full flex items-center justify-center text-green-600 hover:text-green-800 transition transform hover:scale-[1.02] duration-300">
                        <i class="fas fa-plus-circle text-2xl mr-2"></i>
                        <span class="text-lg font-bold">新增產品資料</span>
                    </button>
                </div>

                <div class="bg-white overflow-hidden shadow-lg rounded-xl p-5 border-l-4 border-yellow-500">
                    <button onclick="exportToExcel()" class="w-full h-full flex items-center justify-center text-yellow-600 hover:text-yellow-800 transition transform hover:scale-[1.02] duration-300">
                        <i class="fas fa-file-excel text-2xl mr-2"></i>
                        <span class="text-lg font-bold">匯出 Excel (備份)</span>
                    </button>
                </div>
            </div>

            <!-- 產品列表 -->
            <div class="bg-white shadow-xl overflow-hidden rounded-xl">
                <div class="px-4 py-5 sm:px-6 flex flex-col sm:flex-row justify-between items-center bg-gray-50 border-b border-gray-200">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 title-font mb-2 sm:mb-0">產品清單</h3>
                    <div class="relative w-full sm:w-64">
                        <input type="text" id="search-input" onkeyup="filterProducts()" placeholder="搜尋編號或名稱..." class="shadow-inner focus:ring-amber-500 focus:border-amber-500 block w-full sm:text-sm border-gray-300 rounded-lg p-2 pl-3">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">圖片</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">編號 (SKU)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">蝦皮中文品名</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">單品成本</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">蝦皮優惠價</th>
                                <!-- 調整表格標題顏色以匹配利潤顏色 (蝦皮/綠界) -->
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-red-700">預估蝦皮單品利潤</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-red-700">預估蝦皮套裝利潤</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-green-700">預估綠界單品利潤</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-green-700">預估綠界套裝利潤</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="product-table-body" class="bg-white divide-y divide-gray-100">
                            <!-- 資料將由 JS 插入 -->
                        </tbody>
                    </table>
                    <div id="loading-spinner" class="py-10 flex justify-center hidden">
                        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 訊息提示區 -->
    <div id="temp-message" class="hidden fixed bottom-5 right-5 z-50 p-4 rounded-lg shadow-xl text-white font-bold transition-opacity duration-300 opacity-0"></div>

    <!-- 新增/編輯視窗 -->
    <div id="product-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 overflow-y-auto h-full w-full z-40">
        <div class="relative top-5 mx-auto p-5 border w-full max-w-4xl shadow-2xl rounded-xl bg-white mb-10 transform transition duration-300 ease-out">
            <div class="mt-2">
                <h3 class="text-2xl leading-6 font-bold text-gray-900 mb-4 border-b pb-2 title-font" id="modal-title">新增產品</h3>
                <form id="product-form" onsubmit="handleFormSubmit(event)">
                    <input type="hidden" id="doc-id">
                    <input type="hidden" id="existing_image_url">
                    
                    <!-- 第一區：基本識別與圖片 -->
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-4">
                        <div class="md:col-span-4">
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="sku">1. 上架商品號 (SKU)</label>
                            <input class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:ring-amber-500 focus:border-amber-500 focus:outline-none" id="sku" type="text" placeholder="例如: MS-00001" required>
                        </div>
                        <div class="md:col-span-8">
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="image_file">2. 產品圖上傳 (僅支援 JPG/PNG)</label>
                            <input class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:ring-amber-500 focus:border-amber-500 focus:outline-none bg-white" id="image_file" type="file" accept="image/jpeg, image/png" onchange="previewImage(event)">
                            <div id="image-preview-container" class="mt-2 text-center border-2 border-dashed border-gray-300 rounded-lg p-3 hidden">
                                <img id="image-preview" class="max-h-40 mx-auto rounded-lg object-contain shadow-md" src="" alt="圖片預覽" onerror="this.src='https://placehold.co/160x160/e0e7ff/6366f1?text=Load+Error'">
                                <p id="current-image-name" class="text-xs text-gray-500 mt-2"></p>
                            </div>
                        </div>
                    </div>

                    <!-- 第二區：規格與來源 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <div>
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="weight_kg">3. 預估重量 (kg)</label>
                            <input class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:ring-amber-500 focus:border-amber-500 focus:outline-none" id="weight_kg" type="number" step="0.01" placeholder="單位: kg">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="made_in">4. Made in</label>
                            <input class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:ring-amber-500 focus:border-amber-500 focus:outline-none" id="made_in" type="text" placeholder="例如: KOREA">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="vendor_new_date">5. 檔口上新日期</label>
                            <input class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:ring-amber-500 focus:border-amber-500 focus:outline-none" id="vendor_new_date" type="date">
                        </div>
                    </div>

                    <!-- 第三區：檔口與品名資訊 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="vendor_shop_name">6. 檔口 (廠商名稱)</label>
                            <input class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:ring-amber-500 focus:border-amber-500 focus:outline-none" id="vendor_shop_name" type="text" placeholder="檔口名字">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="vendor_product_name">7. 商品名稱 (檔口品名)</label>
                            <input class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:ring-amber-500 focus:border-amber-500 focus:outline-none" id="vendor_product_name" type="text" placeholder="檔口提供的商品名稱">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                         <div class="md:col-span-2">
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="shopee_name_zh">8. 蝦皮中文品名</label>
                            <input class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:ring-amber-500 focus:border-amber-500 focus:outline-none" id="shopee_name_zh" type="text" placeholder="蝦皮上架用的主標題">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="listing_date">9. 上架日期</label>
                            <input class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:ring-amber-500 focus:border-amber-500 focus:outline-none" id="listing_date" type="date">
                        </div>
                    </div>

                    <!-- 第四區：成本 (黃色背景強調) -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 bg-yellow-50 p-3 rounded-lg border border-yellow-200 shadow-inner">
                        <!-- 10. 幣別選擇 -->
                        <div class="md:col-span-1">
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="cost_currency">10. 檔口成本幣別</label>
                            <select class="shadow-sm border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:ring-yellow-500 focus:border-yellow-500 focus:outline-none bg-white" id="cost_currency" onchange="updateCurrencySymbol()">
                                <option value="KRW">韓幣 (₩)</option>
                                <option value="RMB">人民幣 (¥)</option>
                                <option value="TWD">台幣 (NT$)</option>
                            </select>
                        </div>
                        
                        <!-- 11. 檔口原始成本價 (單品) -->
                        <div class="md:col-span-1">
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="vendor_cost_value_orig">11. 單品原始成本價</label>
                            <div class="relative">
                                <span id="currency-symbol" class="absolute inset-y-0 left-0 flex items-center pl-2 text-gray-600 font-medium">₩</span>
                                <input class="shadow-sm appearance-none border rounded-lg w-full py-2 pl-6 pr-3 text-gray-700 leading-tight focus:ring-yellow-500 focus:border-yellow-500 focus:outline-none border-yellow-400 font-bold bg-white" 
                                       id="vendor_cost_value_orig" 
                                       type="number" 
                                       placeholder="原始幣別成本" 
                                       oninput="calculateEstimatedProfit()">
                            </div>
                        </div>

                        <!-- 12. 單品成本價 (TWD) -->
                        <div class="md:col-span-1">
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="cost_value_twd">12. 單品成本價 (TWD)</label>
                            <input class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:ring-yellow-500 focus:border-yellow-500 focus:outline-none border-yellow-400 font-bold bg-white" 
                                   id="cost_value_twd" 
                                   type="number" 
                                   placeholder="換算後 TWD 成本" 
                                   oninput="calculateEstimatedProfit()">
                        </div>

                        <!-- 13. 套裝總成本 (TWD) -->
                        <div class="md:col-span-1">
                            <label class="block text-gray-700 text-xs font-bold mb-1" for="bundle_cost_value">13. 套裝總成本 (TWD)</label>
                            <input class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:ring-yellow-500 focus:border-yellow-500 focus:outline-none border-yellow-400 font-bold bg-white" 
                                   id="bundle_cost_value" 
                                   type="number" 
                                   placeholder="套裝 TWD 總成本" 
                                   oninput="calculateEstimatedProfit()">
                            <p class="text-xs text-gray-500 mt-1">例如：上衣成本 + 褲子成本</p>
                        </div>
                    </div>

                    <!-- 第五區：單品售價策略 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- 蝦皮區塊 (單品 - 編號 14-16) - 使用紅色系 -->
                        <div class="border p-3 rounded-xl bg-red-50 border-red-200 shadow-md">
                            <p class="text-xs font-bold text-red-800 mb-2 text-center border-b border-red-200 pb-1">單品 - 蝦皮價格與利潤</p>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-gray-600 text-xs mb-1" for="shopee_price_orig">14. 原價</label>
                                    <input class="shadow-sm appearance-none border rounded-lg w-full py-1 px-2 text-sm focus:ring-red-500" id="shopee_price_orig" type="number">
                                </div>
                                <div>
                                    <label class="block text-gray-600 text-xs mb-1" for="shopee_price_discount">15. 優惠價</label>
                                    <input class="shadow-sm appearance-none border border-red-400 rounded-lg w-full py-1 px-2 text-sm font-bold focus:ring-red-500" id="shopee_price_discount" type="number" oninput="calculateEstimatedProfit()">
                                </div>
                            </div>
                            
                            <!-- 16. 預估蝦皮單品利潤 -->
                            <div class="pt-2 border-t border-red-200 mt-3">
                                <label class="block text-gray-700 text-xs font-bold mb-1 text-red-700" for="estimated_shopee_profit">16. 預估蝦皮利潤 <span class="text-xs text-gray-500">(TWD)</span></label>
                                <input class="shadow-inner appearance-none border rounded-lg w-full py-1 px-2 text-sm leading-tight focus:outline-none font-bold text-lg" id="estimated_shopee_profit" type="number" placeholder="自動計算" readonly>
                                <p class="text-xs text-gray-500 mt-1">公式: 優惠價(15) - 單品成本(12)</p>
                            </div>
                        </div>

                        <!-- 綠界區塊 (單品 - 編號 17-19) - 使用藍綠色系 -->
                        <div class="border p-3 rounded-xl bg-cyan-50 border-cyan-200 shadow-md">
                            <p class="text-xs font-bold text-cyan-800 mb-2 text-center border-b border-cyan-200 pb-1">單品 - 綠界價格與利潤</p>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-gray-600 text-xs mb-1" for="greenworld_price_orig">17. 原價</label>
                                    <input class="shadow-sm appearance-none border rounded-lg w-full py-1 px-2 text-sm focus:ring-cyan-500" id="greenworld_price_orig" type="number">
                                </div>
                                <div>
                                    <label class="block text-gray-600 text-xs mb-1" for="greenworld_price_discount">18. 優惠價</label>
                                    <input class="shadow-sm appearance-none border border-cyan-400 rounded-lg w-full py-1 px-2 text-sm font-bold focus:ring-cyan-500" id="greenworld_price_discount" type="number" oninput="calculateEstimatedProfit()">
                                </div>
                            </div>
                            
                            <!-- 19. 預估綠界單品利潤 -->
                            <div class="pt-2 border-t border-cyan-200 mt-3">
                                <label class="block text-gray-700 text-xs font-bold mb-1 text-cyan-700" for="estimated_greenworld_profit">19. 預估綠界利潤 <span class="text-xs text-gray-500">(TWD)</span></label>
                                <input class="shadow-inner appearance-none border rounded-lg w-full py-1 px-2 text-sm leading-tight focus:outline-none font-bold text-lg" id="estimated_greenworld_profit" type="number" placeholder="自動計算" readonly>
                                <p class="text-xs text-gray-500 mt-1">公式: 優惠價(18) - 單品成本(12)</p>
                            </div>
                        </div>
                    </div>

                    <!-- 第六區：套裝售價策略 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- 蝦皮套裝區塊 (編號 20-22) - 使用紅色系，與單品蝦皮相近但區分 -->
                        <div class="border p-3 rounded-xl bg-red-100 border-red-300 shadow-md">
                            <p class="text-xs font-bold text-red-800 mb-2 text-center border-b border-red-300 pb-1">套裝 - 蝦皮價格與利潤</p>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-gray-600 text-xs mb-1" for="shopee_bundle_price_orig">20. 套裝原價</label>
                                    <input class="shadow-sm appearance-none border rounded-lg w-full py-1 px-2 text-sm focus:ring-red-500" id="shopee_bundle_price_orig" type="number">
                                </div>
                                <div>
                                    <label class="block text-gray-600 text-xs mb-1" for="shopee_bundle_price_discount">21. 套裝優惠價</label>
                                    <input class="shadow-sm appearance-none border border-red-400 rounded-lg w-full py-1 px-2 text-sm font-bold focus:ring-red-500" id="shopee_bundle_price_discount" type="number" oninput="calculateEstimatedProfit()">
                                </div>
                            </div>

                            <!-- 22. 預估蝦皮套裝利潤 -->
                            <div class="pt-2 border-t border-red-300 mt-3">
                                <label class="block text-gray-700 text-xs font-bold mb-1 text-red-700" for="estimated_shopee_bundle_profit">22. 預估套裝利潤 <span class="text-xs text-gray-500">(TWD)</span></label>
                                <input class="shadow-inner appearance-none border rounded-lg w-full py-1 px-2 text-sm leading-tight focus:outline-none font-bold text-lg" id="estimated_shopee_bundle_profit" type="number" placeholder="自動計算" readonly>
                                <p class="text-xs text-gray-500 mt-1">公式: 優惠價(21) - 套裝總成本(13)</p>
                            </div>
                        </div>

                        <!-- 綠界套裝區塊 (編號 23-25) - 使用藍綠色系，與單品綠界相近但區分 -->
                        <div class="border p-3 rounded-xl bg-cyan-100 border-cyan-300 shadow-md">
                            <p class="text-xs font-bold text-cyan-800 mb-2 text-center border-b border-cyan-300 pb-1">套裝 - 綠界價格與利潤</p>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-gray-600 text-xs mb-1" for="greenworld_bundle_price_orig">23. 套裝原價</label>
                                    <input class="shadow-sm appearance-none border rounded-lg w-full py-1 px-2 text-sm focus:ring-cyan-500" id="greenworld_bundle_price_orig" type="number">
                                </div>
                                <div>
                                    <label class="block text-gray-600 text-xs mb-1" for="greenworld_bundle_price_discount">24. 套裝優惠價</label>
                                    <input class="shadow-sm appearance-none border border-cyan-400 rounded-lg w-full py-1 px-2 text-sm font-bold focus:ring-cyan-500" id="greenworld_bundle_price_discount" type="number" oninput="calculateEstimatedProfit()">
                                </div>
                            </div>
                            
                            <!-- 25. 預估綠界套裝利潤 -->
                            <div class="pt-2 border-t border-cyan-300 mt-3">
                                <label class="block text-gray-700 text-xs font-bold mb-1 text-cyan-700" for="estimated_greenworld_bundle_profit">25. 預估套裝利潤 <span class="text-xs text-gray-500">(TWD)</span></label>
                                <input class="shadow-inner appearance-none border rounded-lg w-full py-1 px-2 text-sm leading-tight focus:outline-none font-bold text-lg" id="estimated_greenworld_bundle_profit" type="number" placeholder="自動計算" readonly>
                                <p class="text-xs text-gray-500 mt-1">公式: 優惠價(24) - 套裝總成本(13)</p>
                            </div>
                        </div>
                    </div>


                    <div class="mb-4">
                        <label class="block text-gray-700 text-xs font-bold mb-2" for="note">備註 / 細節</label>
                        <textarea class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:ring-amber-500 focus:border-amber-500 focus:outline-none" id="note" rows="2"></textarea>
                    </div>

                    <div class="flex items-center justify-end mt-4 pt-4 border-t border-gray-200">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2 focus:outline-none focus:ring-2 focus:ring-gray-500 transition duration-150">取消</button>
                        <button type="submit" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 transition duration-150 shadow-md hover:shadow-lg">儲存產品資料</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (模組化載入) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // 全域變數
        window.db = null;
        window.storage = null;
        window.productsCollection = null;
        window.allProducts = []; 

        // 嵌入的 Firebase 設定檔
        const EMBEDDED_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAc_WnUBQz6nYqoUNZmMHBm62lKMITAxYA",
            authDomain: "ms-app-710ea.firebaseapp.com",
            projectId: "ms-app-710ea",
            storageBucket: "ms-app-710ea.firebasestorage.app",
            messagingSenderId: "718163218564",
            appId: "1:718163218564:web:ba38466e922ffd27aa32d1"
        };
        
        // 輔助功能：根據幣別代碼返回符號
        function getCurrencySymbol(currencyCode) {
            switch(currencyCode) {
                case 'KRW': return '₩';
                case 'RMB': return '¥';
                case 'TWD': return 'NT$';
                default: return '$';
            }
        }
        
        // 輔助功能：更新幣別符號顯示
        window.updateCurrencySymbol = function() {
            const currencySelect = document.getElementById('cost_currency');
            const symbolSpan = document.getElementById('currency-symbol');
            const selectedCurrency = currencySelect.value;
            symbolSpan.innerText = getCurrencySymbol(selectedCurrency);
        }


        // 輔助功能：計算預估利潤 (同時計算單品和套裝)
        window.calculateEstimatedProfit = function() {
            // --- 單品計算 (以台幣單品成本計算) ---
            const singleCostValueTWD = Number(document.getElementById('cost_value_twd').value) || 0; 
            const shopeePriceDiscount = Number(document.getElementById('shopee_price_discount').value) || 0;
            const greenworldPriceDiscount = Number(document.getElementById('greenworld_price_discount').value) || 0;
            
            // 計算蝦皮單品利潤 (16)
            const estimatedShopeeProfit = shopeePriceDiscount - singleCostValueTWD;
            // 計算綠界單品利潤 (19)
            const estimatedGreenworldProfit = greenworldPriceDiscount - singleCostValueTWD;

            // 更新單品利潤欄位
            const shopeeProfitInput = document.getElementById('estimated_shopee_profit');
            shopeeProfitInput.value = estimatedShopeeProfit.toFixed(0); 
            const greenworldProfitInput = document.getElementById('estimated_greenworld_profit');
            greenworldProfitInput.value = estimatedGreenworldProfit.toFixed(0);
            
            // --- 套裝計算 (以套裝總成本計算) ---
            const bundleCostValue = Number(document.getElementById('bundle_cost_value').value) || 0;
            const shopeeBundleDiscount = Number(document.getElementById('shopee_bundle_price_discount').value) || 0;
            const greenworldBundleDiscount = Number(document.getElementById('greenworld_bundle_price_discount').value) || 0;

            // 計算蝦皮套裝利潤 (22)
            const estimatedShopeeBundleProfit = shopeeBundleDiscount - bundleCostValue;
            // 計算綠界套裝利潤 (25)
            const estimatedGreenworldBundleProfit = greenworldBundleDiscount - bundleCostValue;

            // 更新套裝利潤欄位
            const shopeeBundleProfitInput = document.getElementById('estimated_shopee_bundle_profit');
            shopeeBundleProfitInput.value = estimatedShopeeBundleProfit.toFixed(0);
            const greenworldBundleProfitInput = document.getElementById('estimated_greenworld_bundle_profit');
            greenworldBundleProfitInput.value = estimatedGreenworldBundleProfit.toFixed(0);

            // 根據利潤高低調整顏色
            function applyColor(inputElement, profit) {
                // 清除所有舊顏色
                inputElement.classList.remove('text-red-700', 'bg-red-100', 'text-green-700', 'bg-green-100', 'text-cyan-700', 'bg-cyan-100', 'text-gray-700', 'bg-white');
                
                // 決定顏色 (單品蝦皮/套裝蝦皮/單品綠界/套裝綠界)
                const isShopee = inputElement.id.includes('shopee');
                
                let textColorClass = 'text-gray-700';
                let bgColorClass = 'bg-white';
                
                if (profit > 0) {
                    textColorClass = isShopee ? 'text-red-700' : 'text-cyan-700';
                    bgColorClass = isShopee ? 'bg-red-100' : 'bg-cyan-100';
                } else if (profit < 0) {
                    // 虧損時，蝦皮和綠界都用醒目的紅色
                    textColorClass = 'text-red-700'; 
                    bgColorClass = 'bg-red-50';
                }

                inputElement.classList.add(textColorClass, bgColorClass);
            }

            // 應用新的顏色邏輯 (紅色系/藍綠色系)
            applyColor(shopeeProfitInput, estimatedShopeeProfit); // 蝦皮單品
            applyColor(greenworldProfitInput, estimatedGreenworldProfit); // 綠界單品
            applyColor(shopeeBundleProfitInput, estimatedShopeeBundleProfit); // 蝦皮套裝
            applyColor(greenworldBundleProfitInput, estimatedGreenworldBundleProfit); // 綠界套裝
        };

        // 初始化 Firebase 流程
        function initFirebase(config) {
            try {
                const app = initializeApp(config);
                const auth = getAuth(app);
                window.db = getFirestore(app);
                window.storage = getStorage(app); 
                window.productsCollection = collection(window.db, "products"); 

                signInAnonymously(auth).then(() => {
                    console.log("Logged in anonymously");
                    loadProducts();
                    document.getElementById('app').classList.remove('hidden'); 
                }).catch((error) => {
                    console.error("Auth Error", error);
                    showTemporaryMessage("登入失敗，請檢查 Firebase 設定。", 'bg-red-500');
                    document.getElementById('app').innerHTML = `<div class="text-center py-20 text-red-600 font-bold">Firebase 認證失敗，請檢查 API Key 或連線問題。</div>`;
                    document.getElementById('app').classList.remove('hidden');
                });

            } catch (e) {
                console.error("Firebase 初始化失敗", e);
                showTemporaryMessage("Firebase 初始化失敗，請檢查嵌入的設定是否正確。", 'bg-red-500');
                document.getElementById('app').innerHTML = `<div class="text-center py-20 text-red-600 font-bold">Firebase 初始化失敗：${e.message}</div>`;
                document.getElementById('app').classList.remove('hidden');
            }
        }

        // 啟動流程
        window.onload = function() {
            initFirebase(EMBEDDED_FIREBASE_CONFIG);
            // 初始化幣別符號
            window.updateCurrencySymbol();
        };
        
        // 4. 讀取產品 (Real-time)
        function loadProducts() {
            const spinner = document.getElementById('loading-spinner');
            const tbody = document.getElementById('product-table-body');
            spinner.classList.remove('hidden');
            
            // 由於欄位順序調整，這裡的 orderBy 不變 (仍以 sku 排序)
            const q = query(window.productsCollection, orderBy("sku", "asc")); 

            onSnapshot(q, (querySnapshot) => {
                window.allProducts = [];
                if (querySnapshot.empty && document.getElementById('search-input').value === '') {
                     tbody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-gray-500">尚無產品資料</td></tr>`;
                } else {
                    tbody.innerHTML = '';
                }
                
                let count = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    data.id = doc.id; 
                    window.allProducts.push(data);
                    count++;
                });

                document.getElementById('total-count').innerText = count;
                renderTable(window.allProducts);
                spinner.classList.add('hidden');
            }, (error) => {
                console.error("Error getting documents: ", error);
                if(error.code === 'permission-denied') {
                    tbody.innerHTML = `<tr><td colspan="10" class="px-6 py-4 text-center text-red-600 font-bold text-sm bg-red-50">載入失敗：權限不足！請務必檢查您的 Firestore 安全規則，允許匿名使用者讀取 (allow read: if request.auth != null;)。</td></tr>`;
                } else {
                    tbody.innerHTML = `<tr><td colspan="10" class="px-6 py-4 text-center text-red-500 text-sm">載入資料時發生錯誤：${error.message}</td></tr>`;
                }
                spinner.classList.add('hidden');
            });
        }

        // 5. 渲染表格 (變更：四個利潤欄位顏色區分)
        window.renderTable = function(products) {
            const tbody = document.getElementById('product-table-body');
            tbody.innerHTML = '';

            if (products.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-gray-500">尚無產品資料</td></tr>`;
                return;
            }

            products.forEach(p => {
                const tr = document.createElement('tr');
                
                // 單品成本顯示 (包含原始幣別和台幣成本)
                const origSymbol = getCurrencySymbol(p.cost_currency);
                const costDisplay = `<span class="text-xs text-gray-400">${origSymbol}${p.vendor_cost_value_orig || 0}</span> / NT$${p.cost_value_twd || 0}`;

                // 蝦皮單品優惠價
                const shopeeDiscountPrice = p.shopee_price_discount || p.shopee_price_orig || 0;
                
                // 決定單品/套裝利潤的顏色 (蝦皮: 紅色系, 綠界: 藍綠色系)
                const getProfitClasses = (profit, isShopee) => {
                    if (profit > 0) {
                        return isShopee ? 'text-red-600 font-bold bg-red-50' : 'text-cyan-600 font-bold bg-cyan-50';
                    } else if (profit < 0) {
                        return 'text-red-700 bg-red-100 font-bold'; // 虧損使用統一醒目紅
                    } else {
                        return 'text-gray-500';
                    }
                };

                const shopeeProfitClasses = getProfitClasses(p.estimated_shopee_profit, true);
                const shopeeBundleProfitClasses = getProfitClasses(p.estimated_shopee_bundle_profit, true);
                const greenworldProfitClasses = getProfitClasses(p.estimated_greenworld_profit, false);
                const greenworldBundleProfitClasses = getProfitClasses(p.estimated_greenworld_bundle_profit, false);
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex-shrink-0 h-16 w-16">
                            <img class="h-16 w-16 rounded-lg object-cover shadow-sm" src="${p.image_url || 'https://via.placeholder.com/150?text=No+Image'}" alt="產品圖片" onerror="this.src='https://placehold.co/150x150/f0f0f0/999?text=No+Img'">
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.sku || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate" title="${p.shopee_name_zh}">${p.shopee_name_zh || '未命名'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-700">${costDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-amber-600">NT$${shopeeDiscountPrice}</td>
                    <!-- 利潤區塊 (蝦皮/綠界) -->
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${shopeeProfitClasses}">NT$${p.estimated_shopee_profit || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${shopeeBundleProfitClasses}">NT$${p.estimated_shopee_bundle_profit || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${greenworldProfitClasses}">NT$${p.estimated_greenworld_profit || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${greenworldBundleProfitClasses}">NT$${p.estimated_greenworld_bundle_profit || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editProduct('${p.id}')" class="text-amber-600 hover:text-amber-900 mr-3 p-1 rounded-full hover:bg-amber-100 transition"><i class="fas fa-edit"></i></button>
                        <button onclick="confirmDeleteProduct('${p.id}')" class="text-red-600 hover:text-red-900 p-1 rounded-full hover:bg-red-100 transition"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        };

        // 6. 搜尋過濾 (不變)
        window.filterProducts = function() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = window.allProducts.filter(p => 
                (p.sku && p.sku.toLowerCase().includes(term)) || 
                (p.shopee_name_zh && p.shopee_name_zh.toLowerCase().includes(term)) ||
                (p.vendor_product_name && p.vendor_product_name.toLowerCase().includes(term))
            );
            renderTable(filtered);
        };

        // 7. 處理表單提交 (不變)
        window.handleFormSubmit = async function(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerText;
            
            submitBtn.innerText = "處理中 (請稍候)...";
            submitBtn.disabled = true;

            const docId = document.getElementById('doc-id').value;
            const fileInput = document.getElementById('image_file');
            const existingImageUrl = document.getElementById('existing_image_url').value;
            let imageUrl = existingImageUrl;

            try {
                // 檢查是否有新的圖片要上傳
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const sku = document.getElementById('sku').value.trim() || `product-${Date.now()}`;
                    const storagePath = `product_images/${sku}_${Date.now()}_${file.name}`; 
                    
                    if (!window.storage) {
                         throw new Error("Firebase Storage 未初始化。請檢查您的設定。");
                    }
                    
                    const storageRef = ref(window.storage, storagePath);
                    
                    submitBtn.innerText = "上傳圖片中...";
                    const snapshot = await uploadBytes(storageRef, file);
                    imageUrl = await getDownloadURL(snapshot.ref);
                    showTemporaryMessage("圖片上傳成功！", 'bg-green-500');
                }
                
                // ** 在儲存前，執行利潤計算 **
                window.calculateEstimatedProfit();

                // 收集所有欄位的數據
                const productData = {
                    sku: document.getElementById('sku').value.trim(),
                    image_url: imageUrl, 
                    weight_kg: Number(document.getElementById('weight_kg').value) || 0,
                    made_in: document.getElementById('made_in').value.trim(),
                    vendor_new_date: document.getElementById('vendor_new_date').value,
                    
                    vendor_shop_name: document.getElementById('vendor_shop_name').value.trim(), 
                    vendor_product_name: document.getElementById('vendor_product_name').value.trim(), 
                    
                    shopee_name_zh: document.getElementById('shopee_name_zh').value.trim(),
                    listing_date: document.getElementById('listing_date').value,
                    
                    // 成本
                    cost_currency: document.getElementById('cost_currency').value, 
                    vendor_cost_value_orig: Number(document.getElementById('vendor_cost_value_orig').value) || 0, 
                    cost_value_twd: Number(document.getElementById('cost_value_twd').value) || 0, 
                    bundle_cost_value: Number(document.getElementById('bundle_cost_value').value) || 0, 

                    // 單品價格與利潤
                    shopee_price_orig: Number(document.getElementById('shopee_price_orig').value) || 0, 
                    shopee_price_discount: Number(document.getElementById('shopee_price_discount').value) || 0, 
                    estimated_shopee_profit: Number(document.getElementById('estimated_shopee_profit').value) || 0, 
                    
                    greenworld_price_orig: Number(document.getElementById('greenworld_price_orig').value) || 0, 
                    greenworld_price_discount: Number(document.getElementById('greenworld_price_discount').value) || 0, 
                    estimated_greenworld_profit: Number(document.getElementById('estimated_greenworld_profit').value) || 0, 
                    
                    // 套裝價格與利潤
                    shopee_bundle_price_orig: Number(document.getElementById('shopee_bundle_price_orig').value) || 0, 
                    shopee_bundle_price_discount: Number(document.getElementById('shopee_bundle_price_discount').value) || 0, 
                    estimated_shopee_bundle_profit: Number(document.getElementById('estimated_shopee_bundle_profit').value) || 0, 
                    
                    greenworld_bundle_price_orig: Number(document.getElementById('greenworld_bundle_price_orig').value) || 0, 
                    greenworld_bundle_price_discount: Number(document.getElementById('greenworld_bundle_price_discount').value) || 0, 
                    estimated_greenworld_bundle_profit: Number(document.getElementById('estimated_greenworld_bundle_profit').value) || 0, 

                    note: document.getElementById('note').value.trim(),
                    updated_at: new Date().toISOString()
                };

                // 儲存 Firestore 資料
                submitBtn.innerText = "儲存資料庫中...";
                if (docId) {
                    await updateDoc(doc(window.db, "products", docId), productData);
                } else {
                    productData.created_at = new Date().toISOString();
                    await addDoc(window.productsCollection, productData);
                }
                
                showTemporaryMessage(docId ? "產品資料已更新成功！" : "新產品已新增成功！", 'bg-amber-500');
                closeModal();
            } catch (error) {
                console.error("儲存失敗: ", error);
                showTemporaryMessage(`儲存產品資料失敗！錯誤: ${error.message}. 請檢查 Firebase Storage 規則是否允許寫入。`, 'bg-red-500');
            } finally {
                submitBtn.innerText = originalText;
                submitBtn.disabled = false;
            }
        };

        // 8. 刪除確認 (不變)
        window.confirmDeleteProduct = function(id) {
            if (window.confirm("確定要刪除這個產品嗎？此操作不可逆！")) {
                 deleteProduct(id);
            }
        }

        // 9. 刪除 (不變)
        async function deleteProduct(id) {
            try {
                await deleteDoc(doc(window.db, "products", id));
                showTemporaryMessage("產品已成功刪除。", 'bg-red-500');
            } catch (error) {
                console.error("刪除失敗: ", error.message);
                showTemporaryMessage("刪除產品失敗！", 'bg-red-500');
            }
        };
        
        // 圖片預覽功能 (不變)
        window.previewImage = function(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('image-preview');
            const previewContainer = document.getElementById('image-preview-container');
            const currentName = document.getElementById('current-image-name');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    previewContainer.classList.remove('hidden');
                    currentName.innerText = `將上傳新圖: ${file.name}`;
                };
                reader.readAsDataURL(file);
            } else {
                const existingUrl = document.getElementById('existing_image_url').value;
                if(existingUrl) {
                    preview.src = existingUrl;
                    currentName.innerText = "保留原圖";
                    previewContainer.classList.remove('hidden');
                } else {
                    previewContainer.classList.add('hidden');
                }
            }
        }

        // 10. 編輯/開啟模態視窗 (不變)
        window.editProduct = function(id) {
            const p = window.allProducts.find(item => item.id === id);
            if (!p) return;

            document.getElementById('doc-id').value = id;
            document.getElementById('modal-title').innerText = "編輯產品 (SKU: " + (p.sku || 'N/A') + ")";
            
            document.getElementById('image_file').value = null; 
            
            document.getElementById('existing_image_url').value = p.image_url || '';
            const previewContainer = document.getElementById('image-preview-container');
            const preview = document.getElementById('image-preview');
            const currentName = document.getElementById('current-image-name');
            
            if (p.image_url) {
                preview.src = p.image_url;
                currentName.innerText = "目前圖片已存在 (可重新選擇上傳)";
                previewContainer.classList.remove('hidden');
            } else {
                previewContainer.classList.add('hidden');
            }

            // 填入所有欄位
            document.getElementById('sku').value = p.sku || '';
            document.getElementById('weight_kg').value = p.weight_kg || 0; 
            document.getElementById('made_in').value = p.made_in || '';
            document.getElementById('vendor_new_date').value = p.vendor_new_date || '';
            document.getElementById('vendor_shop_name').value = p.vendor_shop_name || ''; 
            document.getElementById('vendor_product_name').value = p.vendor_product_name || p.vendor_name || ''; 
            document.getElementById('shopee_name_zh').value = p.shopee_name_zh || '';
            document.getElementById('listing_date').value = p.listing_date || '';
            
            // 成本 (修正欄位)
            document.getElementById('cost_currency').value = p.cost_currency || 'KRW';
            document.getElementById('vendor_cost_value_orig').value = p.vendor_cost_value_orig || 0; 
            document.getElementById('cost_value_twd').value = p.cost_value_twd || p.cost_value || 0; 
            document.getElementById('bundle_cost_value').value = p.bundle_cost_value || 0; 
            
            // 單品 (修正編號)
            document.getElementById('shopee_price_orig').value = p.shopee_price_orig || 0; 
            document.getElementById('shopee_price_discount').value = p.shopee_price_discount || 0; 
            document.getElementById('estimated_shopee_profit').value = p.estimated_shopee_profit || 0; 
            
            document.getElementById('greenworld_price_orig').value = p.greenworld_price_orig || 0; 
            document.getElementById('greenworld_price_discount').value = p.greenworld_price_discount || 0; 
            document.getElementById('estimated_greenworld_profit').value = p.estimated_greenworld_profit || 0; 
            
            // 套裝 (修正編號)
            document.getElementById('shopee_bundle_price_orig').value = p.shopee_bundle_price_orig || 0; 
            document.getElementById('shopee_bundle_price_discount').value = p.shopee_bundle_price_discount || 0; 
            document.getElementById('estimated_shopee_bundle_profit').value = p.estimated_shopee_bundle_profit || 0; 

            document.getElementById('greenworld_bundle_price_orig').value = p.greenworld_bundle_price_orig || 0; 
            document.getElementById('greenworld_bundle_price_discount').value = p.greenworld_bundle_price_discount || 0; 
            document.getElementById('estimated_greenworld_bundle_profit').value = p.estimated_greenworld_bundle_profit || 0; 
            
            document.getElementById('note').value = p.note || '';

            // 載入資料後，進行一次計算，確保利潤顯示正確，並更新幣別符號
            window.updateCurrencySymbol();
            window.calculateEstimatedProfit();

            openModal('edit'); // 使用 openModal 確保顯示邏輯統一
        };

        // 11. 匯出 Excel (更新欄位名稱與順序以符合「美化」要求)
        window.exportToExcel = function() {
            if (window.allProducts.length === 0) {
                showTemporaryMessage("沒有資料可以匯出！", 'bg-yellow-500');
                return;
            }
            
            const data = window.allProducts.map(p => ({
                // 圖二要求的欄位順序：
                "產品圖片網址": p.image_url || '',
                "SKU 上架商品號": p.sku || '',
                "蝦皮中文品名": p.shopee_name_zh || '',
                "檔口品名": p.vendor_product_name || p.vendor_name || '', 
                "檔口/廠商": p.vendor_shop_name || '', 
                "Made in": p.made_in || '',
                "上架日期": p.listing_date || '',
                "上新日期": p.vendor_new_date || '',
                "預估重量(KG)": p.weight_kg || 0,
                "備註": p.note || '',

                // 成本資訊
                "成本幣別": p.cost_currency || 'KRW',
                "單品原始成本價": p.vendor_cost_value_orig || 0,
                "單品成本(TWD)": p.cost_value_twd || p.cost_value || 0, 
                "套裝總成本(TWD)": p.bundle_cost_value || 0,

                // 蝦皮利潤區
                "蝦皮-單品原價": p.shopee_price_orig || 0,
                "蝦皮-單品優惠價": p.shopee_price_discount || 0,
                "蝦皮-單品預估利潤": p.estimated_shopee_profit || 0, 
                "蝦皮-套裝原價": p.shopee_bundle_price_orig || 0,
                "蝦皮-套裝優惠價": p.shopee_bundle_price_discount || 0,
                "蝦皮-套裝預估利潤": p.estimated_shopee_bundle_profit || 0,

                // 綠界利潤區
                "綠界-單品原價": p.greenworld_price_orig || 0,
                "綠界-單品優惠價": p.greenworld_price_discount || 0,
                "綠界-單品預估利潤": p.estimated_greenworld_profit || 0, 
                "綠界-套裝原價": p.greenworld_bundle_price_orig || 0,
                "綠界-套裝優惠價": p.greenworld_bundle_price_discount || 0,
                "綠界-套裝預估利潤": p.estimated_greenworld_bundle_profit || 0
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            
            // 由於 SheetJS 本身不支援複雜的樣式，但我們可以確保欄位名稱清晰且順序正確，
            // 以達到「美化」 (結構清晰) 的目的。
            XLSX.utils.book_append_sheet(wb, ws, "產品利潤分析");

            const date = new Date().toISOString().slice(0,10).replace(/-/g, '');
            XLSX.writeFile(wb, `MyStyle_Products_Analysis_${date}.xlsx`);
            
            console.log("匯出完成");
            showTemporaryMessage("產品資料已成功匯出為 Excel 檔案！", 'bg-green-500');
        };

        // UI 輔助功能
        window.openModal = function(type) {
            if (type === 'add') {
                document.getElementById('product-form').reset();
                document.getElementById('doc-id').value = '';
                document.getElementById('existing_image_url').value = ''; 
                document.getElementById('modal-title').innerText = "新增產品";
                document.getElementById('cost_currency').value = 'KRW'; 
                document.getElementById('image-preview-container').classList.add('hidden'); 
                
                document.getElementById('vendor_cost_value_orig').value = 0;
                document.getElementById('cost_value_twd').value = 0; 
                document.getElementById('bundle_cost_value').value = 0; 
                
                document.getElementById('estimated_shopee_profit').value = 0; 
                document.getElementById('estimated_greenworld_profit').value = 0; 
                document.getElementById('estimated_shopee_bundle_profit').value = 0; 
                document.getElementById('estimated_greenworld_bundle_profit').value = 0; 

                // 清除所有利潤欄位的顏色標記
                const profitInputs = [
                    'estimated_shopee_profit', 'estimated_greenworld_profit', 
                    'estimated_shopee_bundle_profit', 'estimated_greenworld_bundle_profit'
                ];
                profitInputs.forEach(id => {
                    const input = document.getElementById(id);
                    input.classList.remove('text-red-700', 'bg-red-100', 'text-green-700', 'bg-green-100', 'text-cyan-700', 'bg-cyan-100');
                    input.classList.add('text-gray-700', 'bg-white');
                });
                
                window.updateCurrencySymbol();
            }
            window.calculateEstimatedProfit();

            document.getElementById('product-modal').classList.remove('hidden');
        };

        window.closeModal = function() {
            document.getElementById('product-modal').classList.add('hidden');
        };

        // 重置設定
        window.clearLocalConfig = function() {
            if(window.confirm("確定要重置設定嗎？目前的 Firebase 設定已嵌入程式碼中，重置只會清除瀏覽器中的歷史設定並重新載入，以便使用新的程式碼版本。")) { 
                localStorage.removeItem('my_style_firebase_config'); 
                location.reload();
            }
        };

        // 臨時訊息提示（取代 Alert）
        function showTemporaryMessage(message, bgColor) {
            let tempDiv = document.getElementById('temp-message');
            if (!tempDiv) {
                tempDiv = document.createElement('div');
                tempDiv.id = 'temp-message';
                tempDiv.className = 'fixed bottom-5 right-5 z-50 p-4 rounded-lg shadow-xl text-white font-bold transition-opacity duration-300 opacity-0';
                document.body.appendChild(tempDiv);
            }
            
            tempDiv.className = `fixed bottom-5 right-5 z-50 p-4 rounded-xl shadow-xl text-white font-bold ${bgColor} opacity-100 transition ease-out duration-300`;
            tempDiv.innerText = message;

            setTimeout(() => {
                tempDiv.classList.remove('opacity-100');
                tempDiv.classList.add('opacity-0');
            }, 3000); 
        }
    </script>
</body>
</html>
